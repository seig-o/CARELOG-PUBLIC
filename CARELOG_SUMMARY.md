# CARELOG Bundle Summary (nightly full)

## src/App.vue

```vue
<!-- src/App.vue -->
<template>
  <!-- Naive UI providers（テンプレは kebab-case！） -->
  <n-config-provider :class="routeClass">
    <n-dialog-provider>
      <n-message-provider>
        <!-- ログインページではヘッダー非表示 -->
        <AppHeader v-if="!isLogin" class="app-header" />

        <!-- 画面全体のラッパ：ログイン時は中央寄せ、通常時は余白つきコンテナ -->
        <main :class="isLogin ? 'center' : 'page-container'">
          <router-view />
        </main>
      </n-message-provider>
    </n-dialog-provider>
  </n-config-provider>
</template>

<script setup lang="ts">
import { computed } from 'vue'
import { useRoute } from 'vue-router'
import AppHeader from '@/components/AppHeader.vue'

const route = useRoute()
// /login（名前 or パス）判定。将来 /login/callback 等にも耐性を持たせるなら startsWith を併用
const isLogin = computed(() => route.name === 'login' || String(route.path).startsWith('/login'))

// route.name をベースにした class を返す
const routeClass = computed(() => {
  if (!route.name) return ''
  // return `page-${route.name}`
  return `page-${String(route.name ?? '')}`
})
</script>

<style scoped>
/* 全ページ共通の背景＆最小高さ */
.app-root {
  min-height: 100vh;
  background: #f7f7f8; /* 薄いグレーで窮屈感を軽減 */
}

/* 通常ページ用のコンテナ：中央寄せ & 余白 */
.page-container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 24px;
}

/* ログインページ用：カード等を中央に置きやすいキャンバス */
.center {
  min-height: 100vh;           /* ヘッダー非表示なので全高でOK */
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 24px;               /* スマホでの端詰まり防止 */
}
</style>```

## src/auto-imports.d.ts

```ts
/* eslint-disable */
/* prettier-ignore */
// @ts-nocheck
// noinspection JSUnusedGlobalSymbols
// Generated by unplugin-auto-import
// biome-ignore lint: disable
export {}
declare global {
  const EffectScope: typeof import('vue')['EffectScope']
  const computed: typeof import('vue')['computed']
  const createApp: typeof import('vue')['createApp']
  const customRef: typeof import('vue')['customRef']
  const defineAsyncComponent: typeof import('vue')['defineAsyncComponent']
  const defineComponent: typeof import('vue')['defineComponent']
  const effectScope: typeof import('vue')['effectScope']
  const getCurrentInstance: typeof import('vue')['getCurrentInstance']
  const getCurrentScope: typeof import('vue')['getCurrentScope']
  const getCurrentWatcher: typeof import('vue')['getCurrentWatcher']
  const h: typeof import('vue')['h']
  const inject: typeof import('vue')['inject']
  const isProxy: typeof import('vue')['isProxy']
  const isReactive: typeof import('vue')['isReactive']
  const isReadonly: typeof import('vue')['isReadonly']
  const isRef: typeof import('vue')['isRef']
  const isShallow: typeof import('vue')['isShallow']
  const markRaw: typeof import('vue')['markRaw']
  const nextTick: typeof import('vue')['nextTick']
  const onActivated: typeof import('vue')['onActivated']
  const onBeforeMount: typeof import('vue')['onBeforeMount']
  const onBeforeRouteLeave: typeof import('vue-router')['onBeforeRouteLeave']
  const onBeforeRouteUpdate: typeof import('vue-router')['onBeforeRouteUpdate']
  const onBeforeUnmount: typeof import('vue')['onBeforeUnmount']
  const onBeforeUpdate: typeof import('vue')['onBeforeUpdate']
  const onDeactivated: typeof import('vue')['onDeactivated']
  const onErrorCaptured: typeof import('vue')['onErrorCaptured']
  const onMounted: typeof import('vue')['onMounted']
  const onRenderTracked: typeof import('vue')['onRenderTracked']
  const onRenderTriggered: typeof import('vue')['onRenderTriggered']
  const onScopeDispose: typeof import('vue')['onScopeDispose']
  const onServerPrefetch: typeof import('vue')['onServerPrefetch']
  const onUnmounted: typeof import('vue')['onUnmounted']
  const onUpdated: typeof import('vue')['onUpdated']
  const onWatcherCleanup: typeof import('vue')['onWatcherCleanup']
  const provide: typeof import('vue')['provide']
  const reactive: typeof import('vue')['reactive']
  const readonly: typeof import('vue')['readonly']
  const ref: typeof import('vue')['ref']
  const resolveComponent: typeof import('vue')['resolveComponent']
  const shallowReactive: typeof import('vue')['shallowReactive']
  const shallowReadonly: typeof import('vue')['shallowReadonly']
  const shallowRef: typeof import('vue')['shallowRef']
  const toRaw: typeof import('vue')['toRaw']
  const toRef: typeof import('vue')['toRef']
  const toRefs: typeof import('vue')['toRefs']
  const toValue: typeof import('vue')['toValue']
  const triggerRef: typeof import('vue')['triggerRef']
  const unref: typeof import('vue')['unref']
  const useAttrs: typeof import('vue')['useAttrs']
  const useCssModule: typeof import('vue')['useCssModule']
  const useCssVars: typeof import('vue')['useCssVars']
  const useId: typeof import('vue')['useId']
  const useLink: typeof import('vue-router')['useLink']
  const useModel: typeof import('vue')['useModel']
  const useRoute: typeof import('vue-router')['useRoute']
  const useRouter: typeof import('vue-router')['useRouter']
  const useSlots: typeof import('vue')['useSlots']
  const useTemplateRef: typeof import('vue')['useTemplateRef']
  const watch: typeof import('vue')['watch']
  const watchEffect: typeof import('vue')['watchEffect']
  const watchPostEffect: typeof import('vue')['watchPostEffect']
  const watchSyncEffect: typeof import('vue')['watchSyncEffect']
}
// for type re-export
declare global {
  // @ts-ignore
  export type { Component, Slot, Slots, ComponentPublicInstance, ComputedRef, DirectiveBinding, ExtractDefaultPropTypes, ExtractPropTypes, ExtractPublicPropTypes, InjectionKey, PropType, Ref, ShallowRef, MaybeRef, MaybeRefOrGetter, VNode, WritableComputedRef } from 'vue'
  import('vue')
}
```

## src/components.d.ts

```ts
/* eslint-disable */
// @ts-nocheck
// Generated by unplugin-vue-components
// Read more: https://github.com/vuejs/core/pull/3399
// biome-ignore lint: disable
export {}

/* prettier-ignore */
declare module 'vue' {
  export interface GlobalComponents {
    AppHeader: typeof import('./components/AppHeader.vue')['default']
    BranchListPanel: typeof import('./components/lobby/BranchListPanel.vue')['default']
    CareLogListPanel: typeof import('./components/lobby/CareLogListPanel.vue')['default']
    CompanyListPanel: typeof import('./components/lobby/CompanyListPanel.vue')['default']
    CompanySwitcher: typeof import('./components/CompanySwitcher.vue')['default']
    NButton: typeof import('naive-ui')['NButton']
    NCard: typeof import('naive-ui')['NCard']
    NConfigProvider: typeof import('naive-ui')['NConfigProvider']
    NDataTable: typeof import('naive-ui')['NDataTable']
    NDescriptions: typeof import('naive-ui')['NDescriptions']
    NDescriptionsItem: typeof import('naive-ui')['NDescriptionsItem']
    NDialogProvider: typeof import('naive-ui')['NDialogProvider']
    NDivider: typeof import('naive-ui')['NDivider']
    NDynamicTags: typeof import('naive-ui')['NDynamicTags']
    NEmpty: typeof import('naive-ui')['NEmpty']
    NForm: typeof import('naive-ui')['NForm']
    NFormItem: typeof import('naive-ui')['NFormItem']
    NInput: typeof import('naive-ui')['NInput']
    NMessageProvider: typeof import('naive-ui')['NMessageProvider']
    NPopconfirm: typeof import('naive-ui')['NPopconfirm']
    NSelect: typeof import('naive-ui')['NSelect']
    NSpace: typeof import('naive-ui')['NSpace']
    NSpin: typeof import('naive-ui')['NSpin']
    NSwitch: typeof import('naive-ui')['NSwitch']
    NTag: typeof import('naive-ui')['NTag']
    RouterLink: typeof import('vue-router')['RouterLink']
    RouterView: typeof import('vue-router')['RouterView']
  }
}
```

## src/components/AppHeader.vue

```vue
<template>
  <n-layout-header bordered class="bg-white/80 backdrop-blur">
    <div class="mx-auto max-w-6xl px-4 h-14 flex items-center gap-4">
      <!-- Brand -->
      <RouterLink to="/" class="font-semibold text-lg hover:opacity-80">
        CARELOG
      </RouterLink>

      <!-- Flat Nav -->
      <div class="flex items-center gap-2 flex-1">
        <n-button
          v-for="item in filteredNav"
          :key="item.key"
          size="small"
          quaternary
          :type="activeKey === item.key ? 'primary' : 'default'"
          @click="go(item.key)"
        >
          {{ item.label }}
        </n-button>
      </div>

      <!-- 右側は親からのスロットで自由に（例：ログイン名表示など） -->
      <slot name="right" />

    </div>
  </n-layout-header>
  <!-- CompanySwitcher（superadminのみ表示） -->
  <CompanySwitcher v-if="isSuperadmin" />
  {{ auth.companyId }}
</template>

<script setup lang="ts">
import { computed } from 'vue'
import { useRouter, useRoute, RouterLink } from 'vue-router'
import { NLayoutHeader, NButton } from 'naive-ui'
import CompanySwitcher from '@/components/CompanySwitcher.vue'
import { useStaffStore } from '@/stores/staff' // ロール判定用
import { useAuthStore } from '@/stores/auth' // ログアウト用

const router = useRouter()
const route = useRoute()
const staff = useStaffStore()
const auth = useAuthStore()

type FlatItem = { label: string; key: string }

/** 必要最低限のルート名だけ定義（存在しないものは自動で除外） */
const flatNav: FlatItem[] = [
  { label: 'ホーム',         key: 'care-log-list' },
  { label: 'ケアログ一覧',   key: 'care-log-list'  },
  { label: 'ケアログ新規',   key: 'care-log-new'   },
  { label: '利用者一覧',     key: 'user-list'      },
  { label: '利用者新規',     key: 'user-new'       },
  { label: 'スタッフ一覧',   key: 'staff-list'     },
  { label: 'スタッフ新規',   key: 'staff-new'      },
  { label: '拠点一覧',       key: 'branch-list'    },
  { label: '拠点新規',       key: 'branch-new'     },
  { label: '会社一覧',       key: 'company-list'   },
  { label: '会社新規',       key: 'company-new'    },
  { label: 'ログアウト',       key: 'login'    },
]

/** ルートが存在するものだけ表示 */
const filteredNav = computed(() =>
  flatNav.filter(i => router.hasRoute(i.key as any))
)

/** DataTable等で route.name が symbol の場合があるので文字列化 */
const activeKey = computed(() => String(route.name ?? ''))

/** superadmin判定（Piniaストアから） */
const isSuperadmin = computed(() => auth.role === 'superadmin')

async function go(name: string) {
  if (!router.hasRoute(name as any)) {
    console.warn('[AppHeader] Unknown route name:', name)
    return
  }
  if (name === 'login') {
    // ログアウト時は強制的にリロード（状態クリアのため）
    auth.signOut()
    return
  }
  await router.push({ name: name as any })
}

const emit = defineEmits(['company-changed'])

async function onCompanyChange (companyId: string | null) {
  if (!companyId) return
  await auth.setCompanyId(companyId)
  emit('company-changed') // ← これで親に通知
}
</script>

<style scoped>
/* 見た目の微調整があればここに */
</style>
```

## src/components/CompanySwitcher.vue

```vue
<template>
  <div style="margin-bottom: 16px">
    <n-select
      v-model:value="selectedCompanyId"
      :options="companyOptions"
      placeholder="操作対象の会社を選択"
      :loading="loading"
      clearable
      @update:value="onCompanyChange"
    />
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue'
import { NSelect } from 'naive-ui'
import { useAuthStore } from '@/stores/auth'
import { supabase } from '@/lib/supabase'
import { TABLE, ROUTE } from '@/lib/contracts'

const auth = useAuthStore()
const selectedCompanyId = ref<string | null>(auth.companyId ?? null)
const companyOptions = ref<{ label: string; value: string }[]>([])
const loading = ref(false)

async function fetchCompanies () {
  loading.value = true
  const { data, error } = await supabase
    .from(TABLE.companies)
    .select('id, name')
    .order('id', { ascending: true })

  if (error) {
    console.error('会社一覧の取得に失敗しました', error)
  } else {
    companyOptions.value = (data ?? []).map(c => ({
      label: c.name ?? '(名称未設定)',
      value: c.id
    }))
  }
  loading.value = false
}

async function onCompanyChange (companyId: string | null) {
  if (!companyId) return
  await auth.setCompanyId(companyId)
  console.info('company_idを切り替えました:', companyId)
  // 必要なら画面再読み込みやデータ再取得
  // location.reload() や emit('refresh') など
}

onMounted(fetchCompanies)
</script>
```

## src/components/lobby/BranchListPanel.vue

```vue
<script setup lang="ts">
import { ref, onMounted } from 'vue'
import { fromCare } from '@/lib/supabase'
import { TABLE } from '@/lib/contracts'
import { useMessage } from 'naive-ui'

type Branch = { id: string; name: string | null; status?: string | null; phone?: string | null; address?: string | null; company_id?: string | null; updated_at?: string | null }

const props = defineProps<{
  companyId?: string | null
  clickable?: boolean
  showToolbar?: boolean
  title?: string
}>()

const emit = defineEmits<{
  (e: 'select', row: Branch): void
}>()

const message = useMessage()
const loading = ref(false)
const items = ref<Branch[]>([])
const q = ref('')

async function load() {
  loading.value = true
  try {
    let query = fromCare(TABLE.branches)
      .select('id, name, status, phone, address, company_id, updated_at')

    if (props.companyId) {
      query = query.eq('company_id', props.companyId)
    }

    const { data, error } = await query.order('name', { ascending: true })
    if (error) throw error
    items.value = data ?? []
  } catch (e:any) {
    console.error(e)
    message.error(e?.message ?? '拠点一覧の取得に失敗しました')
  } finally {
    loading.value = false
  }
}

const filtered = computed(() => {
  const kw = q.value.trim()
  if (!kw) return items.value
  return items.value.filter(b =>
    (b.name ?? '').includes(kw) ||
    (b.address ?? '').includes(kw) ||
    (b.phone ?? '').includes(kw)
  )
})

function onRowClick(b: Branch) {
  if (!props.clickable) return
  emit('select', b)
}

onMounted(load)
</script>

<template>
  <div>
    <div v-if="showToolbar" class="flex items-center justify-between mb-3">
      <div class="text-lg font-semibold">{{ title || '拠点一覧' }}</div>
      <n-input v-model:value="q" placeholder="拠点名 / 住所 / 電話" clearable style="width: 260px" />
    </div>

    <n-spin :show="loading">
      <div v-if="!loading && filtered.length === 0" class="text-gray-500 py-8 text-center">
        該当する拠点がありません
      </div>

      <div v-else class="divide-y">
        <div
          v-for="b in filtered" :key="b.id"
          class="py-3 flex items-start justify-between gap-4 hover:bg-gray-50 rounded transition cursor-pointer"
          @click="onRowClick(b)"
        >
          <div class="min-w-0">
            <div class="text-base font-medium text-blue-600 hover:underline">
              {{ b.name || '(名称未設定)' }}
            </div>
            <div class="text-xs text-gray-500 truncate">ID: {{ b.id }}</div>
            <div class="text-xs text-gray-500 truncate">住所: {{ b.address || '—' }} / 電話: {{ b.phone || '—' }}</div>
          </div>
          <div class="flex items-center gap-3 shrink-0">
            <n-tag :type="(b.status || 'active') === 'active' ? 'success' : 'warning'">
              {{ b.status || 'active' }}
            </n-tag>
            <div class="text-xs text-gray-400 hidden sm:block">
              更新: {{ (b.updated_at || '').slice(0, 16).replace('T', ' ') }}
            </div>
          </div>
        </div>
      </div>
    </n-spin>
  </div>
</template>

<style scoped>
.divide-y > * + * { border-top: 1px solid rgba(0,0,0,0.06); }
</style>```

## src/components/lobby/CareLogListPanel.vue

```vue
<script setup lang="ts">
import { ref, onMounted, watch, computed } from 'vue'
import { fromCare } from '@/lib/supabase'
import { TABLE } from '@/lib/contracts'

type Props = {
  branchId?: string
  clickable?: boolean
  showToolbar?: boolean
}
const props = withDefaults(defineProps<Props>(), {
  clickable: false,
  showToolbar: false
})

const loading = ref(false)
const items = ref<any[]>([])

const hasFilter = computed(() => !!props.branchId)

async function loadLogs() {
  loading.value = true
  try {
    let q = fromCare(TABLE.careLogs)
      .select('id, date, title, summary, tags, branch_id, user_id, staff_id')
      .order('date', { ascending: false })
      .limit(100)

    if (props.branchId) q = q.eq('branch_id', props.branchId)

    const { data, error } = await q
    if (error) throw error
    items.value = data ?? []
  } finally {
    loading.value = false
  }
}

onMounted(loadLogs)
watch(() => props.branchId, loadLogs)

const emit = defineEmits<{
  (e: 'select', row: any): void
}>()

function clickRow(row: any) {
  if (props.clickable) emit('select', row)
}
</script>

<template>
  <div class="flex flex-col gap-3">
    <div v-if="showToolbar" class="flex items-center justify-between">
      <div class="text-sm text-gray-500">
        ケアログ一覧
        <span v-if="hasFilter" class="ml-2">（branch_id={{ branchId }}）</span>
      </div>
      <slot name="toolbar-right" />
    </div>

    <n-spin :show="loading">
      <n-empty v-if="!loading && items.length === 0" description="該当するケアログがありません" />

      <div v-else class="grid gap-3">
        <n-card
          v-for="log in items"
          :key="log.id"
          class="cursor-pointer"
          :class="{'hover:shadow': clickable}"
          @click="clickRow(log)"
        >
          <div class="flex items-center justify-between">
            <div class="font-medium">
              {{ log.title || '（無題）' }}
            </div>
            <div class="text-sm text-gray-500">
              {{ log.date }}
            </div>
          </div>

          <div v-if="log.summary" class="mt-1 text-gray-700 text-sm">
            {{ log.summary }}
          </div>

          <div v-if="Array.isArray(log.tags) && log.tags.length" class="mt-2 flex flex-wrap gap-6">
            <div
              v-for="t in log.tags"
              :key="t"
              class="text-[12px] text-gray-600"
            >
              <span class="inline-block align-middle mr-1">#</span>{{ t }}
            </div>
          </div>
        </n-card>
      </div>
    </n-spin>
  </div>
</template>

<style scoped>
.hover\:shadow:hover { box-shadow: 0 8px 24px rgba(0,0,0,0.08); }
</style>```

## src/components/lobby/CompanyListPanel.vue

```vue
<script setup lang="ts">
import { ref, onMounted } from 'vue'
import { fromCare } from '@/lib/supabase'
import { TABLE } from '@/lib/contracts'
import { useMessage } from 'naive-ui'

type Company = { id: string; name: string | null; status?: string | null; created_at?: string | null; updated_at?: string | null }

const props = defineProps<{
  clickable?: boolean
  showToolbar?: boolean
}>()

const emit = defineEmits<{
  (e: 'select', row: Company): void
}>()

const message = useMessage()
const loading = ref(false)
const items = ref<Company[]>([])
const q = ref('')

async function load() {
  loading.value = true
  try {
    const { data, error } = await fromCare(TABLE.companies)
      .select('id, name, status, created_at, updated_at')
      .order('name', { ascending: true })
    if (error) throw error
    items.value = data ?? []
  } catch (e:any) {
    console.error(e)
    message.error(e?.message ?? '会社一覧の取得に失敗しました')
  } finally {
    loading.value = false
  }
}

const filtered = computed(() => {
  const kw = q.value.trim()
  if (!kw) return items.value
  return items.value.filter(c =>
    (c.name ?? '').includes(kw) || (c.id ?? '').includes(kw)
  )
})

function onRowClick(c: Company) {
  if (!props.clickable) return
  emit('select', c)
}

onMounted(load)
</script>

<template>
  <div>
    <div v-if="showToolbar" class="flex items-center justify-between mb-3">
      <div class="text-lg font-semibold">会社一覧</div>
      <n-input v-model:value="q" placeholder="会社名 / ID" clearable style="width: 240px" />
    </div>

    <n-spin :show="loading">
      <div v-if="!loading && filtered.length === 0" class="text-gray-500 py-8 text-center">
        会社がありません
      </div>
      <div v-else class="divide-y">
        <div
          v-for="c in filtered" :key="c.id"
          class="py-3 flex items-center justify-between hover:bg-gray-50 rounded transition cursor-pointer"
          @click="onRowClick(c)"
        >
          <div class="min-w-0">
            <div class="text-base font-medium text-blue-600 hover:underline">
              {{ c.name || c.id }}
            </div>
            <div class="text-xs text-gray-500 truncate">ID: {{ c.id }}</div>
          </div>
          <div class="flex items-center gap-3">
            <n-tag :type="(c.status || 'active') === 'active' ? 'success' : 'warning'">
              {{ c.status || 'active' }}
            </n-tag>
            <div class="text-xs text-gray-400 hidden sm:block">
              更新: {{ (c.updated_at || '').slice(0,16).replace('T',' ') }}
            </div>
          </div>
        </div>
      </div>
    </n-spin>
  </div>
</template>

<style scoped>
.divide-y > * + * { border-top: 1px solid rgba(0,0,0,0.06); }
</style>```

## src/lib/contracts.ts

```ts
// src/lib/contracts.ts
// CareLog「唯一の正」= carelog-canon.json をコードへ反映する参照ハブ。
// ここに無いものは使わない。追加・変更は先に canon を更新してから。

/**
 * スキーマ名
 * - 現状は public に一本化
 */
export const SCHEMA = {
  public: 'public'
} as const

/**
 * 物理テーブル名（スキーマ名を含まない）
 * - 完全修飾名が欲しい場合は fq.table(...) を使うか、FQ_TABLE を利用
 */
export const TABLE = {
  staffs:  'staffs',
  users:   'users',
  branches:'branches',
  careLogs:'care_logs',
  careLogRevisions: 'care_log_revisions',
  staffBranchMemberships: 'staff_branch_memberships', // 中間: staff×branch (M:N)
  userBranchMemberships:  'user_branch_memberships',  // 中間: user×branch (M:N)
  companies: 'companies',
} as const

/**
 * ビュー名（スキーマ名を含まない）
 */
export const VIEW = {
  vCareLogs: 'v_care_logs',
  userWithBranches:  'v_user_with_branches',
  staffWithBranches: 'v_staff_with_branches'
} as const

/**
 * RPC（定義が決まったらここに）
 */
export const RPC = {
  // 追加が決まったらここに
} as const

/**
 * ルート名とURLパスの契約
 * - name: 既存のルート名（後方互換）
 * - path: 直感的URL（/resource/list, /resource/new, /resource/:id, /resource/:id/edit）
 * - NOTE: careLog/carelogs 混在は解消し、キーは careLogs に統一。name は既存互換（care-log-*）を維持。
 */
export const ROUTE = {
  top: {
    name: {
      superadmin: 'top-superadmin',
      admin:      'top-admin',
      manager:    'top-manager'
    },
    path: {
      superadmin: '/top/superadmin',
      admin:      '/top/admin',
      manager:    '/top/manager'
    }
  },
  users: {
    name: {
      list:   'user-list',
      detail: 'user-detail',
      edit:   'user-edit',
      new:    'user-new'
    },
    path: {
      list:   '/user/list',
      new:    '/user/new',
      detail: (id: string) => `/user/${id}`,
      edit:   (id: string) => `/user/${id}/edit`
    }
  },
  staffs: {
    name: {
      list:   'staff-list',
      detail: 'staff-detail',
      edit:   'staff-edit',
      new:    'staff-new'
    },
    path: {
      list:   '/staff/list',
      new:    '/staff/new',
      detail: (id: string) => `/staff/${id}`,
      edit:   (id: string) => `/staff/${id}/edit`
    }
  },
  branches: {
    name: {
      list: 'branch-list',
      detail: 'branch-detail',
      edit: 'branch-edit',
      new:  'branch-new'
    },
    path: {
      list:   '/branch/list',
      new:    '/branch/new',
      detail: (id: string) => `/branch/${id}`,
      edit:   (id: string) => `/branch/${id}/edit`
    }
  },
  companies: {
    name: {
      list:   'company-list',
      detail: 'company-detail',
      edit:   'company-edit',
      new:    'company-new'
    },
    path: {
      list:   '/company/list',
      new:    '/company/new',
      detail: (id: string) => `/company/${id}`,
      edit:   (id: string) => `/company/${id}/edit`
    }
  },
  careLogs: {
    name: {
      list:   'care-log-list',
      detail: 'care-log-detail',
      edit:   'care-log-edit',
      new:    'care-log-new'
    },
    path: {
      list:   '/care-log/list',
      new:    '/care-log/new',
      detail: (id: string) => `/care-log/${id}`,
      edit:   (id: string) => `/care-log/${id}/edit`
    }
  }
} as const

/**
 * 完全修飾名（schema.table / schema.view）を作るヘルパ
 * - public は「非修飾」を返す（= 既定スキーマ）
 * - ログ / supabase.from() などでの参照に便利
 */
export const fq = {
  table: (t: keyof typeof TABLE, schema: keyof typeof SCHEMA = 'public') =>
    schema === 'public' ? TABLE[t] : `${SCHEMA[schema]}.${TABLE[t]}`,
  view: (v: keyof typeof VIEW, schema: keyof typeof SCHEMA = 'public') =>
    schema === 'public' ? VIEW[v] : `${SCHEMA[schema]}.${VIEW[v]}`
}

/**
 * 利便性向上：よく使う完全修飾名を定数としても公開
 * - 画面では supabase.from(FQ_TABLE.USERS) のように使う
 */
export const FQ_TABLE = {
  STAFFS:                fq.table('staffs'),
  USERS:                 fq.table('users'),
  BRANCHES:              fq.table('branches'),
  CARE_LOGS:             fq.table('careLogs'),
  CARE_LOG_REVISIONS:    fq.table('careLogRevisions'),
  STAFF_BRANCH_MEMBER:   fq.table('staffBranchMemberships'),
  USER_BRANCH_MEMBER:    fq.table('userBranchMemberships'),
  COMPANIES:             fq.table('companies'),
} as const

export const FQ_VIEW = {
  V_CARE_LOGS:           fq.view('vCareLogs'),
  V_USER_WITH_BRANCHES:  fq.view('userWithBranches'),
  V_STAFF_WITH_BRANCHES: fq.view('staffWithBranches')
} as const

/**
 * 既存コード互換エイリアス（好みでこちらを import してもOK）
 * - プロジェクト内の呼び方を FQ_TABLE.* に寄せるまでの橋渡し
 */
export const FQ_USERS      = FQ_TABLE.USERS
export const FQ_STAFFS     = FQ_TABLE.STAFFS
export const FQ_BRANCHES   = FQ_TABLE.BRANCHES
export const FQ_CARE_LOGS  = FQ_TABLE.CARE_LOGS
export const FQ_COMPANIES  = FQ_TABLE.COMPANIES

/**
 * 型の補助
 */
type ValueOf<T> = T[keyof T]
export type TableKey = keyof typeof TABLE
export type ViewKey  = keyof typeof VIEW

// ルート名（string literal の合併）
export type RouteName =
  | ValueOf<typeof ROUTE['users']['name']>
  | ValueOf<typeof ROUTE['staffs']['name']>
  | ValueOf<typeof ROUTE['branches']['name']>
  | ValueOf<typeof ROUTE['companies']['name']>
  | ValueOf<typeof ROUTE['careLogs']['name']>```

## src/lib/date.ts

```ts
// ローカル時間基準で 'YYYY-MM-DD' ⇄ epoch(ms) を相互変換（UTC系APIは使わない）

/** 'YYYY-MM-DD' → epoch(ms) | null */
export function ymdStringToMs(ymd: string | null): number | null {
  if (!ymd) return null
  const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(ymd)
  if (!m) throw new Error(`ymdStringToMs: invalid format: ${ymd}`)
  const y = Number(m[1]); const mon = Number(m[2]); const d = Number(m[3])
  const dt = new Date(y, mon - 1, d, 0, 0, 0, 0) // ローカル00:00
  return dt.getTime()
}

/** epoch(ms) → 'YYYY-MM-DD' | null */
export function msToYmdString(ms: number | null): string | null {
  if (ms === null || ms === undefined) return null
  const d = new Date(ms)
  const yyyy = d.getFullYear()
  const mm = String(d.getMonth() + 1).padStart(2, '0')
  const dd = String(d.getDate()).padStart(2, '0')
  return `${yyyy}-${mm}-${dd}`
}

/** 任意入力（string|Date|number|null）を 'YYYY-MM-DD' に正規化 */
export function toYmd(value: string | Date | number | null): string | null {
  if (value == null) return null
  if (typeof value === 'string') {
    if (!/^\d{4}-\d{2}-\d{2}$/.test(value)) {
      throw new Error(`toYmd: invalid string: ${value}`)
    }
    return value
  }
  if (value instanceof Date) return msToYmdString(value.getTime())
  if (typeof value === 'number') return msToYmdString(value)
  return null
}```

## src/lib/db/branches.ts

```ts
import { supabase } from '@/lib/supabase'
import type { Branch } from '@/types/branch'

export async function listBranches(): Promise<Branch[]> {
  const { data, error } = await supabase
    .from('branches')
    .select('id, name, address, phone') // ✅ カラムを明示
    .order('name', { ascending: true })
  if (error) throw error
  return data as Branch[]
}```

## src/lib/db/me.ts

```ts
import { supabase } from '@/lib/supabase'
import type { Staff } from '@/types/staff'

export async function getMe(): Promise<Staff | null> {
  const { data: auth } = await supabase.auth.getUser()
  const uid = auth.user?.id
  if (!uid) return null
  const { data, error } = await supabase
    .from('staffs')
    .select('id, auth_user_id, name, role') // ✅ user_id → auth_user_id に修正
    .eq('auth_user_id', uid)
    .maybeSingle()
  if (error) throw error
  return data as Staff | null
}```

## src/lib/db/staffs.ts

```ts
import { supabase } from '@/lib/supabase'
import type { Staff } from '@/types/staff'

const table = 'staffs'
const mTable = 'staff_branch_memberships'

export async function listStaffs(): Promise<Staff[]> {
  const { data, error } = await supabase
    .from(table)
    .select('id, auth_user_id, name, role, created_at, updated_at')
    .order('created_at', { ascending: false })
  if (error) throw error
  return data as unknown as Staff[]
}

export async function getStaffById(id: string): Promise<Staff | null> {
  const { data, error } = await supabase
    .from(table)
    .select('id, auth_user_id, name, role, created_at, updated_at')
    .eq('id', id)
    .maybeSingle()
  if (error) throw error
  return data as unknown as Staff | null
}

type CreateStaffInput = {
  name: string
  role: Staff['role']
  auth_user_id?: string | null
}
export async function createStaff(input: CreateStaffInput): Promise<Staff> {
  const { data, error } = await supabase
    .from(table)
    .insert({
      name: input.name,
      role: input.role,
      auth_user_id: input.auth_user_id ?? null,
    })
    .select('id, auth_user_id, name, role, created_at, updated_at')
    .single()
  if (error) throw error
  return data as unknown as Staff
}

export async function updateStaff(id: string, input: Partial<CreateStaffInput>): Promise<Staff> {
  const { data, error } = await supabase
    .from(table)
    .update({
      name: input.name,
      role: input.role,
      auth_user_id: input.auth_user_id,
    })
    .eq('id', id)
    .select('id, auth_user_id, name, role, created_at, updated_at')
    .single()
  if (error) throw error
  return data as unknown as Staff
}

export async function deleteStaff(id: string): Promise<void> {
  const { error } = await supabase.from(table).delete().eq('id', id)
  if (error) throw error
}

/** memberships */
export async function getStaffMembershipBranchIds(staffId: string): Promise<string[]> {
  const { data, error } = await supabase
    .from(mTable)
    .select('branch_id')
    .eq('staff_id', staffId)
  if (error) throw error
  return (data ?? []).map((r: any) => r.branch_id as string)
}

export async function syncStaffMemberships(staffId: string, nextBranchIds: string[]) {
  const { data: curData, error: curErr } = await supabase
    .from(mTable)
    .select('id,branch_id')
    .eq('staff_id', staffId)
  if (curErr) throw curErr

  const cur = new Set((curData ?? []).map((r:any)=> r.branch_id as string))
  const next = new Set(nextBranchIds)

  const toAdd = [...next].filter(id => !cur.has(id))
  const toDel = (curData ?? []).filter((r:any)=> !next.has(r.branch_id)).map((r:any)=> r.id as string)

  if (toAdd.length) {
    const rows = toAdd.map(id => ({ staff_id: staffId, branch_id: id }))
    const { error } = await supabase.from(mTable).insert(rows)
    if (error) throw error
  }
  if (toDel.length) {
    const { error } = await supabase.from(mTable).delete().in('id', toDel)
    if (error) throw error
  }
}

/** 主所属の切替（オプション） */
export async function setPrimaryBranch(staffId: string, branchId: string) {
  // 全false → 指定1件をtrue
  const { error: e1 } = await supabase
    .from(mTable)
    .update({ is_primary: false })
    .eq('staff_id', staffId)
    .eq('is_primary', true)
  if (e1) throw e1

  const { error: e2 } = await supabase
    .from(mTable)
    .update({ is_primary: true })
    .eq('staff_id', staffId)
    .eq('branch_id', branchId)
  if (e2) throw e2
}```

## src/lib/db/users.ts

```ts
import { supabase } from '@/lib/supabase'
import type { CareUser } from '@/types/user'

const table = 'users' // care.users
const mTable = 'user_branch_memberships'

export async function listUsers(): Promise<CareUser[]> {
  const { data, error } = await supabase
    .from(table)
    .select('*')
    .order('created_at', { ascending: false })
  if (error) throw error
  return data as CareUser[]
}

export async function getUserById(id: string): Promise<CareUser | null> {
  const { data, error } = await supabase
    .from(table)
    .select('*')
    .eq('id', id)
    .maybeSingle()
  if (error) throw error
  return data as CareUser | null
}

type CreateUserInput = Partial<Omit<CareUser, 'id' | 'created_at' | 'updated_at'>>
export async function createUser(input: CreateUserInput): Promise<CareUser> {
  const { data, error } = await supabase
    .from(table)
    .insert(input)
    .select('*')
    .single()
  if (error) throw error
  return data as CareUser
}

export async function updateUser(id: string, input: Partial<CareUser>): Promise<CareUser> {
  const { data, error } = await supabase
    .from(table)
    .update(input)
    .eq('id', id)
    .select('*')
    .single()
  if (error) throw error
  return data as CareUser
}

export async function deleteUser(id: string): Promise<void> {
  const { error } = await supabase.from(table).delete().eq('id', id)
  if (error) throw error
}

/** memberships */
export async function getUserMembershipBranchIds(userId: string): Promise<string[]> {
  const { data, error } = await supabase
    .from(mTable)
    .select('branch_id')
    .eq('user_id', userId)
  if (error) throw error
  return (data ?? []).map((r: any) => r.branch_id as string)
}

export async function syncUserMemberships(userId: string, nextBranchIds: string[]) {
  const { data: curData, error: curErr } = await supabase
    .from(mTable)
    .select('id,branch_id')
    .eq('user_id', userId)
  if (curErr) throw curErr

  const cur = new Set((curData ?? []).map((r: any) => r.branch_id as string))
  const next = new Set(nextBranchIds)

  const toAdd = [...next].filter(id => !cur.has(id))
  const toDel = (curData ?? [])
    .filter((r: any) => !next.has(r.branch_id))
    .map((r: any) => r.id as string)

  if (toAdd.length) {
    const rows = toAdd.map(id => ({ user_id: userId, branch_id: id }))
    const { error } = await supabase.from(mTable).insert(rows)
    if (error) throw error
  }
  if (toDel.length) {
    const { error } = await supabase.from(mTable).delete().in('id', toDel)
    if (error) throw error
  }
}```

## src/lib/supabase.ts

```ts
// src/lib/supabase.ts
import { createClient } from '@supabase/supabase-js'

const supabaseUrl =
  import.meta.env.VITE_SUPABASE_URL || process.env.VITE_SUPABASE_URL
const supabaseAnonKey =
  import.meta.env.VITE_SUPABASE_ANON_KEY || process.env.VITE_SUPABASE_ANON_KEY

if (!supabaseUrl || !supabaseAnonKey) {
  // eslint-disable-next-line no-console
  console.error('[supabase] Missing VITE_SUPABASE_URL or VITE_SUPABASE_ANON_KEY')
}

export const supabase = createClient(supabaseUrl!, supabaseAnonKey!)

// --- 互換レイヤ（移行完了までの暫定措置） -------------------------
// 以前の `fromCare('table')` をそのまま動かすための薄いラッパ。
// 置換作業が一巡したら、下記2行は削除して問題ありません。
export const fromCare = (table: string) => supabase.from(table)
// --------------------------------------------------------------```

## src/lib/utils.ts

```ts
// utils.ts
import { ref } from 'vue'

type ImeGuardOpts = {
  /** IME確定後、この時間内は「2回目のEnter」で実行する（ms） */
  doubleEnterWindowMs?: number
  /** compositionend直後の同一押下Enterを無視する猶予（ms） */
  suppressAfterCompMs?: number
}

export function useImeGuard(opts: ImeGuardOpts = {}) {
  const windowMs  = opts.doubleEnterWindowMs ?? 800
  const suppressMs = opts.suppressAfterCompMs ?? 60  // ★ 直後Enter抑止

  const isComposing = ref(false)
  const needDoubleUntil = ref(0)        // この時刻まで二度押し要求
  const awaitingSecond  = ref(false)    // 次のEnterで実行するフラグ
  const suppressUntil   = ref(0)        // compositionend直後の同一押下を食べる

  const onCompStart = () => { isComposing.value = true }
  const onCompEnd = () => {
    isComposing.value = false
    needDoubleUntil.value = performance.now() + windowMs
    awaitingSecond.value = true            // ★ すでに1回押された前提にする
    suppressUntil.value  = performance.now() + suppressMs // ★ 同一押下のEnterを抑止
  }

  /** Enter押下：IME中は無視。二度押し期間は awaitingSecond に応じて実行。 */
  const onEnter = (cb: () => void) => (e: KeyboardEvent) => {
    // @ts-ignore
    const composing = isComposing.value || e.isComposing === true || (e as any).keyCode === 229
    if (composing) return

    const now = performance.now()

    // compositionend直後の“同一押下”は食べる
    if (now <= suppressUntil.value) {
      e?.preventDefault?.()
      return
    }

    if (now <= needDoubleUntil.value) {
      // 二度押し期間中
      if (awaitingSecond.value) {
        // これが“2回目”
        awaitingSecond.value = false
        needDoubleUntil.value = 0
        e?.preventDefault?.()
        cb()
      } else {
        // ここには基本来ない想定（保険）
        awaitingSecond.value = true
        e?.preventDefault?.()
      }
      return
    }

    // 通常時は1回で実行（英数入力時のUX維持）
    e?.preventDefault?.()
    cb()
  }

  const onBlur = () => {
    awaitingSecond.value = false
    needDoubleUntil.value = 0
    suppressUntil.value = 0
    isComposing.value = false
  }

  return { isComposing, onCompStart, onCompEnd, onEnter, onBlur }
}

// そのまま（全角スペース正規化＋重複排除）
export function pushUniqueTag(list: string[] | undefined, tag: string): string[] {
  const t = String(tag ?? '').replace(/\u3000/g, ' ').trim()
  const arr = Array.isArray(list) ? list.slice() : []
  if (t && !arr.includes(t)) arr.push(t)
  return arr
}```

## src/main.ts

```ts
// src/main.ts
import '@/assets/style.css'
import { createApp } from 'vue'
import { createPinia } from 'pinia'
import router from './router'
// if (import.meta.env.DEV) {
//   // @ts-ignore
//   (window as any).router = router
// }
import App from './App.vue'

import { supabase } from '@/lib/supabase'
if (import.meta.env.DEV) {
  // @ts-ignore
  (window as any).supabase = supabase
}
import { useAuthStore } from '@/stores/auth'

// ★ Naive UI: 使うものだけ個別 import → create() でプラグイン化
import {
  create,
  NConfigProvider,
  NDialogProvider,
  NMessageProvider,
  NForm,
  NFormItem,
  NInput,
  NButton,
  NCard,
  NDataTable,
  NTag,
  NSelect,
  NDatePicker,
  // ▼ 追加（エラー解消）
  NSpace,
  // ▼ 予防（AppHeader の n-layout-header を安定化）
  NLayout,
  NLayoutHeader,
  NSpin,
  NDescriptions,
  NDescriptionsItem,
  NEmpty,
  NPopconfirm,
  NInputNumber,
  NSwitch,
  NDynamicTags
} from 'naive-ui'

// 必要なコンポーネントだけ登録（足りなければ随時追加）
const naive = create({
  components: [
    NConfigProvider,
    NDialogProvider,
    NMessageProvider,
    NForm,
    NFormItem,
    NInput,
    NButton,
    NCard,
    NDataTable,
    NTag,
    NSelect,
    NDatePicker,
    // ▼ 追加
    NSpace,
    // ▼ 予防
    NLayout,
    NLayoutHeader,
    NSpin,
    NDescriptions,
    NDescriptionsItem,
    NEmpty,
    NPopconfirm,
    NInputNumber,
    NSwitch,
    NDynamicTags
  ]
})

async function bootstrap() {
  const app = createApp(App)
  const pinia = createPinia()
  app.use(pinia)
  app.use(router)
  app.use(naive) // ← ここが重要（providers や各 Naive コンポーネントが解決される）

  // --- Auth 初期化（v2 仕様）--------------------------
  const auth = useAuthStore()

  // セッション取得 → store 反映
  {
    const { data: { session }, error } = await supabase.auth.getSession()
    if (error) console.error('[init auth] getSession error:', error)
    auth.setSession(session ?? null)
  }

  // 変化監視
  supabase.auth.onAuthStateChange((event, session) => {
    auth.setSession(session ?? null)
    if (event === 'SIGNED_OUT' && router.currentRoute.value.name !== 'login') {
      router.push({ name: 'login' }).catch(() => {})
    }
  })
  // ----------------------------------------------------

  await router.isReady()
  app.mount('#app')
}

bootstrap().catch((e) => {
  console.error('[bootstrap] unhandled error:', e)
})```

## src/router/index.ts

```ts
// src/router/index.ts
import { TABLE, ROUTE } from '@/lib/contracts'
import { useCtxStore } from '@/stores/ctx'
import { supabase, fromCare } from '@/lib/supabase'
import { createRouter, createWebHistory } from 'vue-router'
import type { RouteLocationNormalized, NavigationGuardNext } from 'vue-router'

// Users
import UserList from '@/views/users/UserList.vue'
import UserUpsert from '@/views/users/UserUpsert.vue'
const UserDetail = () => import('@/views/users/UserDetail.vue')

// Staffs
import StaffList from '@/views/staffs/StaffList.vue'
import StaffUpsert from '@/views/staffs/StaffUpsert.vue'
const StaffDetail = () => import('@/views/staffs/StaffDetail.vue')

// Branches
import BranchList from '@/views/branches/BranchList.vue'
import BranchUpsert from '@/views/branches/BranchUpsert.vue'
const BranchDetail = () => import('@/views/branches/BranchDetail.vue')

// Companies
import CompanyList from '@/views/companies/CompanyList.vue'
const CompanyUpsert = () => import('@/views/companies/CompanyUpsert.vue')
const CompanyDetail = () => import('@/views/companies/CompanyDetail.vue')

// CareLogs（新モジュール）
const CareLogList = () => import('@/views/carelogs/CareLogList.vue')
const CareLogDetail = () => import('@/views/carelogs/CareLogDetail.vue')
const CareLogUpsert = () => import('@/views/carelogs/CareLogUpsert.vue')

const routes = [
  // Login
  {
    path: '/login',
    name: 'login',
    meta: { public: true, hideHeader: true },
    component: () => import('@/views/LoginView.vue'),
  },

  // ルート：固定リダイレクトをやめ、ガードで動的に割り振る
  {
    path: '/',
    name: 'root',
    meta: { public: true },
    component: { render: () => null } // 空コンポーネント
  },

  // ========= 役割別トップ =========
  {
    path: '/top/superadmin',
    name: 'top-superadmin',
    component: () => import('@/views/TopSuperadmin.vue'),
    meta: { requiresSuperadmin: true }
  },
  {
    path: '/top/admin',
    name: 'top-admin',
    component: () => import('@/views/TopAdmin.vue'),
    meta: { requiresAdmin: true }
  },
  {
    path: '/top/manager',
    name: 'top-manager',
    component: () => import('@/views/TopManager.vue'),
    meta: { requiresManager: true }
  },

  // 会社ロビー（= その会社の拠点一覧を出す画面）
  { 
    path: '/company/:companyId/branches',
    name: 'company-lobby',
    component: BranchList,                       // 既存の BranchList を流用
    meta: { requiresAdmin: true }                // superadmin も通過可（beforeEachのALLOW_ADMIN_ROLESにより）
  },

  // 拠点ロビー（= その拠点のケアログ一覧を出す画面）
  {
    path: '/branch/:branchId/lobby',
    name: 'branch-lobby',
    component: () => import('@/views/BranchLobby.vue')
  },
  {
    path: '/branch/:branchId/care-logs',
    name: 'branch-care-logs',                    // ← 修正：重複を解消
    component: CareLogList,
    // meta は任意
  },

  // ========= 新URL（直感優先: /resource/list,new,:id,:id/edit） =========

  // Users
  { path: '/user/list',       name: 'user-list',   component: UserList,   meta: { requiresAdmin: true } },
  { path: '/user/new',        name: 'user-new',    component: UserUpsert, meta: { requiresAdmin: true } },
  { path: '/user/:id',        name: 'user-detail', component: UserDetail, meta: { requiresAdmin: true } },
  { path: '/user/:id/edit',   name: 'user-edit',   component: UserUpsert, meta: { requiresAdmin: true } },

  // Staffs
  { path: '/staff/list',      name: 'staff-list',   component: StaffList,   meta: { requiresAdmin: true } },
  { path: '/staff/new',       name: 'staff-new',    component: StaffUpsert, meta: { requiresAdmin: true } },
  { path: '/staff/:id',       name: 'staff-detail', component: StaffDetail, meta: { requiresAdmin: true } },
  { path: '/staff/:id/edit',  name: 'staff-edit',   component: StaffUpsert, meta: { requiresAdmin: true } },

  // Branches
  { path: '/branch/list',         name: 'branch-list', component: BranchList,   meta: { requiresAdmin: true } },
  { path: '/branch/new',          name: 'branch-new',  component: BranchUpsert, meta: { requiresAdmin: true } },
  { path: '/branch/:id',          name: 'branch-detail', component: BranchDetail, meta: { requiresAdmin: true } },
  { path: '/branch/:id/edit',     name: 'branch-edit', component: BranchUpsert, meta: { requiresAdmin: true } },

  // Companies（superadminのみ）
  { path: '/company/list',             name: 'company-list',   component: CompanyList, meta: { requiresSuperadmin: true }  },
  { path: '/company/new',              name: 'company-new',    component: CompanyUpsert, meta: { requiresSuperadmin: true }  },
  { path: '/company/:companyId',       name: 'company-detail', component: CompanyDetail, meta: { requiresSuperadmin: true }  },
  { path: '/company/:companyId/edit',  name: 'company-edit',   component: CompanyUpsert, meta: { requiresSuperadmin: true }  },

  // CareLogs
  { path: '/care-log/list',       name: 'care-log-list',   component: CareLogList },
  { path: '/care-log/new',        name: 'care-log-new',    component: CareLogUpsert },
  { path: '/care-log/:id',        name: 'care-log-detail', component: CareLogDetail },
  { path: '/care-log/:id/edit',   name: 'care-log-edit',   component: CareLogUpsert },

  // 短縮: /branches ＝ 現在会社の拠点一覧
  {
    path: '/branches',
    name: 'branches-short',
    meta: { requiresAdmin: true },
    beforeEnter: async () => true, // 既存 beforeEach が動く前提
    component: () => import('@/views/branches/BranchList.vue')
  },

  // 短縮: /care-logs ＝ 現在拠点のケアログ一覧
  {
    path: '/care-logs',
    name: 'care-logs-short',
    // RLS的には誰でもOKなら meta なしでもOK。管理UIなら requiresManager でも良い
    component: () => import('@/views/carelogs/CareLogList.vue')
  }
]

const router = createRouter({
  history: createWebHistory(import.meta.env.BASE_URL),
  routes
})

// ルーターガード（マージ版）
let _roleCache: { role: 'superadmin' | 'admin' | 'manager' | null; at: number } | null = null
const ROLE_TTL_MS = 5 * 60 * 1000
const ALLOW_ADMIN_ROLES = ['admin', 'manager', 'superadmin'] as const
const ALLOW_MANAGER_ROLES = ['manager', 'admin', 'superadmin'] as const

async function fetchRole(): Promise<'superadmin' | 'admin' | 'manager' | null> {
  const now = Date.now()
  if (_roleCache && now - _roleCache.at < ROLE_TTL_MS) return _roleCache.role

  const { data: { user } } = await supabase.auth.getUser()
  if (!user) {
    _roleCache = { role: null, at: now }
    return null
  }
  const { data: staff, error } = await supabase
    .from('staffs')
    .select('role')
    .eq('auth_user_id', user.id)
    .maybeSingle()

  if (error) {
    console.error('[router] staff fetch error:', error)
    _roleCache = { role: null, at: now }
    return null
  }
  const r = (staff as any)?.role ?? null
  const role = r === 'superadmin' ? 'superadmin' : r === 'admin' ? 'admin' : r === 'manager' ? 'manager' : null
  _roleCache = { role, at: now }
  return role
}

function topNameByRole(role: 'superadmin' | 'admin' | 'manager' | null) {
  if (role === 'superadmin') return 'top-superadmin'
  if (role === 'admin')      return 'top-admin'
  return 'top-manager'
}

router.beforeEach(async (to) => {
  const { data: { session } } = await supabase.auth.getSession()
  const isPublic = !!to.meta.public

  // /login 特例
  if (to.name === 'login') {
    if (session) {
      const role = await fetchRole()
      return { name: topNameByRole(role), replace: true }
    }
    return true
  }

  // /（root）を動的に役割Topへ
  if (to.name === 'root') {
    if (!session) return { name: 'login' }
    const role = await fetchRole()
    return { name: topNameByRole(role), replace: true }
  }

  // 要認証
  if (!isPublic && !session) {
    return { name: 'login', query: { redirect: to.fullPath } }
  }

  const role = await fetchRole()

  // Top直叩きの整列
  if (to.name === 'top-superadmin' && role !== 'superadmin') {
    return { name: topNameByRole(role), replace: true }
  }
  if (to.name === 'top-admin' && !(role === 'admin' || role === 'superadmin')) {
    return { name: topNameByRole(role), replace: true }
  }

  // requiresAdmin
  if (to.meta.requiresAdmin) {
    if (!role || !ALLOW_ADMIN_ROLES.includes(role)) {
      return { name: 'login', query: { redirect: to.fullPath } }
    }
  }

  // requiresManager
  if (to.meta.requiresManager) {
    if (!role || !ALLOW_MANAGER_ROLES.includes(role)) {
      return { name: topNameByRole(role), replace: true }
    }
  }

  // superadmin限定
  if (to.meta.requiresSuperadmin) {
    if (role !== 'superadmin') {
      return { name: topNameByRole(role), replace: true }
    }
  }

  // /branches は company コンテキスト必須
  if (to.name === 'branches-short') {
    const ctx = useCtxStore()
    if (!ctx.company?.id) {
      // 文脈が無ければ旧フルパスへ誘導（一覧でもOK）
      return { name: 'company-list' }
    }
  }

  // /care-logs は branch コンテキスト必須
  if (to.name === 'care-logs-short') {
    const ctx = useCtxStore()
    if (!ctx.branch?.id || !ctx.branch?.companyId) {
      // 文脈が無ければ旧フルパスへ誘導
      return { name: 'care-log-list' }
      // もしくは会社/拠点のトップへ戻す運用でもOK
    }
  }

  return true
})

export default router```

## src/stores/auth.ts

```ts
// src/stores/auth.ts
import { defineStore } from 'pinia'
import type { Session, User } from '@supabase/supabase-js'
import { supabase } from '@/lib/supabase'

type StaffRow = {
  id: string
  name: string | null
  email: string | null
  role: 'admin' | 'manager' | 'staff' | null
  auth_user_id: string | null
}

type State = {
  user: User | null
  staff: StaffRow | null
  initialized: boolean
  loading: boolean
  error: string | null
  session: Session | null
}

export const useAuthStore = defineStore('auth', {
  state: (): State => ({
    user: null,
    staff: null,
    initialized: false,
    loading: false,
    error: null,
    session: null
  }),

  getters: {
    isLoggedIn: (s) => !!s.user,
    role: (s) => s.staff?.role ?? null,
    staffId: (s) => s.staff?.id ?? null,
    companyId: (s) => s.staff?.company_id ?? null,
  },

  actions: {
    /**
     * main.ts 側の onAuthStateChange / getSession に合わせた受け皿。
     */
    async setSession(session: Session | null) {
      this.loading = true
      this.error = null
      try {
        const user = session?.user ?? null
        this.user = user
        this.session = session ?? null

        if (!user) {
          this.staff = null
          this.initialized = true
          return
        }

        const { data: staff, error: stErr } = await supabase
          .from('staffs') // public に一本化
          .select('id, name, email, role, auth_user_id')
          .eq('auth_user_id', user.id)
          .maybeSingle()

        if (stErr) {
          console.error('[auth.setSession] fetch staff error:', stErr)
          this.staff = null
        } else {
          this.staff = (staff ?? null) as StaffRow
        }
        console.log(staff)
      } catch (e: any) {
        this.error = e?.message ?? String(e)
        console.error('[auth.setSession] unexpected error:', e)
      } finally {
        this.loading = false
        this.initialized = true
      }
    },

    /**
     * ログイン
     * - supabase.auth.signInWithPassword を実行
     * - 成功時に setSession を呼び出し
     */
    async signIn(email: string, password: string) {
      this.loading = true
      this.error = null
      try {
        const { data, error } = await supabase.auth.signInWithPassword({
          email,
          password
        })
        if (error) throw error
        await this.setSession(data.session)
        // ログイン成功したらemail, passwordをlocalstorageに保存する
        localStorage.setItem('email', email)
        localStorage.setItem('password', password)
        return data.session
      } catch (e: any) {
        this.error = e?.message ?? String(e)
        console.error('[auth.signIn] error:', e)
        throw e
      } finally {
        this.loading = false
      }
    },

    /**
     * サインアウト
     */
    async signOut() {
      this.loading = true
      this.error = null
      try {
        const { error } = await supabase.auth.signOut()
        if (error) throw error
        this.user = null
        this.staff = null
        this.session = null
        this.companies = []
      } catch (e: any) {
        this.error = e?.message ?? String(e)
        console.error('[auth.signOut] error:', e)
        throw e
      } finally {
        this.loading = false
      }
    },

    /**
     * ローカル state のみをクリア
     */
    logoutLocal() {
      this.user = null
      this.staff = null
      this.session = null
      this.error = null
      this.initialized = true
    },

    /**
     * 現在セッションから初期化
     */
    async initFromCurrentSession() {
      try {
        const { data, error } = await supabase.auth.getSession()
        if (error) {
          console.error('[auth.initFromCurrentSession] getSession error:', error)
        }
        await this.setSession(data?.session ?? null)
      } catch (e) {
        console.error('[auth.initFromCurrentSession] unexpected error:', e)
      }
    },
    /**
     * staff.company_id を更新する
     * - RPC 経由で更新
     */
    async setCompanyId(companyId: string) {
      if (!this.staff) return

      this.staff.company_id = companyId

      const { error } = await supabase.rpc('set_current_company_id', {
        company_id: companyId
      })

      if (error) {
        console.error('[auth.setCompanyId] RPC error:', error)
        this.error = error.message
      } else {
        console.info('[auth.setCompanyId] company_id updated:', companyId)
      }
    }

  },
})```

## src/stores/ctx.ts

```ts
import { defineStore } from 'pinia'

type CtxCompany = { id: string; name?: string } | null
type CtxBranch  = { id: string; companyId?: string; name?: string } | null

export const useCtxStore = defineStore('ctx', {
  state: () => ({
    company: null as CtxCompany,
    branch:  null as CtxBranch
  }),
  actions: {
    setCompany(c: CtxCompany) {
      this.company = c
      if (!c) this.branch = null // 会社クリア時は拠点もクリア
    },
    setBranch(b: CtxBranch) { this.branch = b }
  }
})```

## src/stores/staff.ts

```ts
// src/stores/staff.ts
import { defineStore } from 'pinia'

export const useStaffStore = defineStore('staff', {
  state: () => ({
    role: null as 'superadmin' | 'admin' | 'manager' | null,
    companyId: null as string | null
  }),
  actions: {
    setRole(role: 'superadmin' | 'admin' | 'manager') {
      this.role = role
    },
    setCompanyId(id: string) {
      this.companyId = id
    }
  }
})
```

## src/types/branch.ts

```ts
export type Branch = {
  id: string
  name: string
  address?: string | null
  phone?: string | null
}```

## src/types/staff.ts

```ts
export type StaffRole = 'admin' | 'manager' | 'caregiver' | 'nurse' | string

export type Staff = {
  id: string
  auth_user_id: string | null
  name: string
  role: StaffRole
  // branch_id は廃止。所属は staff_branch_memberships を参照
}

export type StaffBranchMembership = {
  id: string
  staff_id: string
  branch_id: string
  is_primary?: boolean
}```

## src/types/user.ts

```ts
export type Sex = 'male' | 'female' | 'other'

export type CareUser = {
  id: string
  // ✅ 削除: branch_id は membership に統一
  // branch_id: string | null
  name: string
  name_kana?: string | null
  birthday?: string | null // 'YYYY-MM-DD'
  sex?: Sex | null
  notes?: string | null
  archived_at?: string | null
  created_at: string
  updated_at: string
}

// もし「主所属IDだけを一緒に扱いたい」場面があるなら、読み取り用型を追加（任意）
export type CareUserWithPrimary = CareUser & {
  primary_branch_id: string | null
}

export type UserBranchMembership = {
  id: string
  user_id: string
  branch_id: string
  // 主所属をクライアントで扱うなら型にも持たせる（DBに列あり）
  is_primary?: boolean
}```

## src/views/BranchLobby.vue

```vue
<script setup lang="ts">

import { computed } from 'vue'
import { useRoute, useRouter } from 'vue-router'
import CareLogListPanel from '@/components/lobby/CareLogListPanel.vue'

const route = useRoute()
const router = useRouter()

const branchId = computed(() => route.params.branchId as string)

function goCareLogDetail(row: { id: string }) {
  router.push({ name: 'care-log-detail', params: { id: row.id } })
}
</script>

<template>
  <div class="max-w-5xl mx-auto py-8">
    <n-card>
      <div class="flex items-center justify-between mb-3">
        <h1 class="text-xl font-semibold">
          ブランチロビー（ケアログ）
          <span class="text-gray-500 text-base ml-2">branch_id={{ branchId }}</span>
        </h1>
        <n-button type="primary" tertiary @click="$router.push({ name: 'care-log-new' })">
          新規ケアログ
        </n-button>
      </div>

      <CareLogListPanel
        :branch-id="branchId"
        :clickable="true"
        :show-toolbar="true"
        @select="goCareLogDetail"
      />
    </n-card>
  </div>
</template>```

## src/views/CareLogList.vue

```vue
<script setup lang="ts">
import CareLogList from '@/views/carelogs/CareLogList.vue'
</script>

<template>
  <CareLogList />
</template>```

## src/views/CompanyLobby.vue

```vue
<script setup lang="ts">
import { useRoute, useRouter } from 'vue-router'
import BranchListPanel from '@/components/lobby/BranchListPanel.vue'

const route = useRoute()
const router = useRouter()
const companyId = route.params.companyId as string

function handleSelect(b: { id: string }) {
  router.push({ name: 'branch-lobby', params: { branchId: b.id } })
}
</script>

<template>
  <div class="max-w-5xl mx-auto py-8">
    <n-card>
      <BranchListPanel
        :company-id="companyId"
        :clickable="true"
        :show-toolbar="true"
        title="拠点一覧（会社ロビー）"
        @select="handleSelect"
      />
    </n-card>
  </div>
</template>```

## src/views/LoginView.vue

```vue
<script setup lang="ts">
import { ref } from 'vue'
import { useRouter } from 'vue-router'
import { supabase, fromCare } from '@/lib/supabase'
import { TABLE } from '@/lib/contracts'
import { useMessage } from 'naive-ui'

import LOGO_CARELOG from '@/assets/LOGO_CARELOG.png'

const isDev = import.meta.env.DEV
const DEV_EMAIL = (import.meta.env.VITE_DEV_EMAIL as string | undefined) ?? ''
const DEV_PASSWORD = (import.meta.env.VITE_DEV_PASSWORD as string | undefined) ?? ''

const email = ref(isDev ? DEV_EMAIL : '')
const password = ref(isDev ? DEV_PASSWORD : '')
const loading = ref(false)
const message = useMessage()
const router = useRouter()

// LoginView.vue 内：routeToRoleTop を差し替え
async function routeToRoleTop() {
  const { data: { user } } = await supabase.auth.getUser()
  const uid = user?.id
  if (!uid) {
    router.replace({ name: 'care-log-list' })
    return
  }

  // ヘルパ
  const go = (name: string, path: string) => {
    if (router.hasRoute(name)) router.replace({ name })
    else router.replace(path)
  }

  // 1) superadmin を最優先で判定（← 引数なし RPC に修正）
  try {
    const { data, error } = await supabase.rpc('fn_is_superadmin')
    if (!error && data === true) {
      go('top-superadmin', '/top/superadmin')
      return
    }
  } catch {
    // noop（失敗しても下の通常ロール判定へ）
  }

  // 2) staffs.role（admin / manager など）
  try {
    const { data: staff } = await fromCare(TABLE.staffs)
      .select('role')
      .eq('auth_user_id', uid)
      .maybeSingle()

    const role = (staff as any)?.role ?? 'manager'
    if (role === 'admin') {
      go('top-admin', '/top/admin')
      return
    }
    // manager or 未設定 → manager 扱い
    go('top-manager', '/top/manager')
    return
  } catch {
    // 3) フォールバック
    go('care-log-list', '/care-log/list')
  }
}

async function login() {
  try {
    loading.value = true
    const { error } = await supabase.auth.signInWithPassword({
      email: email.value,
      password: password.value
    })
    if (error) throw error
    await routeToRoleTop()
  } catch (e: any) {
    console.error(e)
    message.error(e?.message ?? 'ログインに失敗しました')
  } finally {
    loading.value = false
  }
}
</script>

<template>
  <div class="max-w-sm mx-auto py-12">
    <n-card>
      <h1 id="logintitle" class="mb-2">
        <img src="@/assets/LOGO_CARELOG.png">
        <span>for ADMIN</span>
      </h1>
      <n-space vertical :size="12">
        <n-input v-model:value="email" placeholder="メールアドレス" type="text" />
        <n-input v-model:value="password" placeholder="パスワード" type="password" />
        <n-button type="primary" :loading="loading" @click="login">ログイン</n-button>

        <div v-if="isDev" class="text-xs text-gray-500">
          開発モード: .env の VITE_DEV_EMAIL / VITE_DEV_PASSWORD を初期値に使用中
        </div>
      </n-space>
    </n-card>
  </div>
</template>```

## src/views/TopAdmin.vue

```vue
<!-- TopAdmin.vue -->
<script setup lang="ts">
import { computed } from 'vue'
import { useRouter, useRoute } from 'vue-router'
import BranchListPanel from '@/components/lobby/BranchListPanel.vue'

import { useCtxStore } from '@/stores/ctx'
const ctx = useCtxStore()

const router = useRouter()
const route = useRoute()

// companyId があればその会社に属するブランチのみを表示（なければ全件）
const companyId = computed(() => (route.query.companyId as string | undefined) || undefined)

function goBranchLobby(b: { id: string; name?: string }) {
  // companyId はパネル側で渡せるなら付ける。無ければ ctx.company?.id を補完
  ctx.setBranch({ id: b.id, companyId: ctx.company?.id, name: b.name })
  router.push({ name: 'care-logs-short' })
}
</script>

<template>
  <div class="max-w-5xl mx-auto py-8">
    <n-card>
      <div class="flex items-center justify-between mb-3">
        <h1 class="text-xl font-semibold">
          管理者トップ（ブランチ一覧）
          <span v-if="companyId" class="ml-2 text-gray-500 text-base">
            company_id={{ companyId }}
          </span>
        </h1>
        <n-button type="primary" tertiary @click="$router.push({ name: 'branch-new' })">
          拠点を新規追加
        </n-button>
      </div>

      <BranchListPanel
        :company-id="companyId"
        :clickable="true"
        :show-toolbar="true"
        @select="goBranchLobby"
      />
    </n-card>
  </div>
</template>```

## src/views/TopManager.vue

```vue
<script setup lang="ts">
import { useRouter, useRoute } from 'vue-router'
import CareLogListPanel from '@/components/lobby/CareLogListPanel.vue'

const router = useRouter()
const route = useRoute()
const branchId = (route.query.branchId as string) || undefined

function goDetail(r: { id: string }) {
  router.push({ name: 'care-log-detail', params: { id: r.id } })
}
</script>

<template>
  <div class="max-w-5xl mx-auto py-8">
    <n-card>
      <div class="flex items-center justify-between mb-3">
        <h1 class="text-xl font-semibold">現場責任者トップ</h1>
        <n-button type="primary" tertiary @click="$router.push({ name: 'care-log-new' })">新規ケアログ</n-button>
      </div>
      <CareLogListPanel :branch-id="branchId" :clickable="true" :show-toolbar="true" @select="goDetail" />
    </n-card>
  </div>
</template>```

## src/views/TopSuperadmin.vue

```vue
<script setup lang="ts">
import { useRouter } from 'vue-router'
import { useCtxStore } from '@/stores/ctx'
import CompanyListPanel from '@/components/lobby/CompanyListPanel.vue'

const router = useRouter()
const ctx = useCtxStore()

function goCompanyLobby(c: { id: string; name?: string }) {
  ctx.setCompany({ id: c.id, name: c.name })
  // 会社が決まったので /branches に遷移（BranchList は companyId を内部で参照）
  router.push({ name: 'branches-short' })
}
</script>

<template>
  <div class="max-w-5xl mx-auto py-8">
    <n-card>
      <div class="flex items-center justify-between mb-3">
        <h1 class="text-xl font-semibold">システム管理者トップ</h1>
        <n-button type="primary" tertiary @click="$router.push({ name: 'company-new' })">
          会社を新規追加
        </n-button>
      </div>
      <CompanyListPanel
        :clickable="true"
        :show-toolbar="true"
        @select="goCompanyLobby"
      />
    </n-card>
  </div>
</template>```

## src/views/branches/BranchDetail.vue

```vue
<template>
  <div class="p-4">
    <n-card title="拠点詳細">
      <template #header-extra>
        <n-space>
          <n-button @click="goList">一覧へ</n-button>
          <n-button type="primary" :disabled="!branch?.id" @click="goEdit">編集</n-button>
          <n-popconfirm
            :negative-text="'キャンセル'"
            :positive-text="'削除'"
            @positive-click="onDelete"
          >
            <template #trigger>
              <n-button type="error" :disabled="!branch?.id">削除</n-button>
            </template>
            本当に削除しますか？
          </n-popconfirm>
        </n-space>
      </template>

      <n-spin :show="loading">
        <template v-if="branch">
          <n-descriptions
            bordered
            label-placement="left"
            :column="2"
            class="mb-4"
          >
            <n-descriptions-item label="ID">
              <code>{{ branch.id }}</code>
            </n-descriptions-item>
            <n-descriptions-item label="会社ID">
              <code v-if="branch.company_id">{{ branch.company_id }}</code>
              <span v-else>—</span>
            </n-descriptions-item>

            <n-descriptions-item label="拠点名">
              {{ branch.name || '—' }}
            </n-descriptions-item>
            <n-descriptions-item label="状態">
              <n-tag :type="statusTagType(branch.status)">{{ branch.status ?? '—' }}</n-tag>
            </n-descriptions-item>

            <n-descriptions-item label="作成日時">
              {{ formatTs(branch.created_at) }}
            </n-descriptions-item>
            <n-descriptions-item label="更新日時">
              {{ formatTs(branch.updated_at) }}
            </n-descriptions-item>
          </n-descriptions>
        </template>
        <template v-else>
          <n-empty description="データが見つかりませんでした" />
        </template>
      </n-spin>
    </n-card>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted, computed } from 'vue'
import { useRoute, useRouter } from 'vue-router'
import { useMessage } from 'naive-ui'
import { supabase } from '@/lib/supabase'
import { TABLE, ROUTE } from '@/lib/contracts'

type Branch = {
  id: string
  name: string | null
  company_id?: string | null
  status?: string | null
  created_at?: string | null
  updated_at?: string | null
}

const route = useRoute()
const router = useRouter()
const message = useMessage()

const branch = ref<Branch | null>(null)
const loading = ref(false)
const branchId = computed(() => route.params.id as string)

function formatTs (ts?: string | null) {
  if (!ts) return '—'
  const d = new Date(ts)
  return d.toLocaleString('ja-JP', {
    year: 'numeric', month: '2-digit', day: '2-digit',
    hour: '2-digit', minute: '2-digit', second: '2-digit'
  })
}

function statusTagType (status?: string | null) {
  const s = (status || '').toLowerCase()
  if (s === 'active') return 'success'
  if (s === 'inactive' || s === 'disabled') return 'warning'
  return 'default'
}

async function load () {
  loading.value = true
  try {
    // company_id / status は存在すれば拾う。無ければ undefined のまま（画面は '—' 表示）
    const { data, error } = await supabase
      .from(TABLE.branches)
      .select('id,name,company_id,status,created_at,updated_at')
      .eq('id', branchId.value)
      .maybeSingle()

    if (error) throw error
    if (!data) {
      message.warning('拠点が見つかりませんでした')
      return
    }
    branch.value = data as Branch
  } catch (e: any) {
    console.error('[BranchDetail] load error:', e)
    message.error(e?.message ?? '読み込みに失敗しました')
  } finally {
    loading.value = false
  }
}

function goList () {
  router.push({ name: ROUTE.branches.name.list })
}
function goEdit () {
  router.push({ name: ROUTE.branches.name.edit, params: { id: branchId.value } })
}

async function onDelete () {
  try {
    const { error } = await supabase.from(TABLE.branches).delete().eq('id', branchId.value)
    if (error) throw error
    message.success('削除しました')
    goList()
  } catch (e: any) {
    console.error('[BranchDetail] delete error:', e)
    message.error(e?.message ?? '削除に失敗しました')
  }
}

onMounted(load)
</script>

<style scoped>
.p-4 { padding: 1rem; }
.mb-4 { margin-bottom: 1rem; }
</style>```

## src/views/branches/BranchList.vue

```vue
<template>
  <div>
    <n-space justify="space-between" align="center" class="mb-4">
      <h2 class="text-xl font-bold">拠点一覧</h2>
      <n-button type="primary" @click="goNew">新規追加</n-button>
    </n-space>

    <n-data-table
      :columns="columns"
      :data="branches"
      :loading="loading"
      :pagination="pagination"
    />
  </div>
</template>

<script setup lang="ts">
import { ref, h, onMounted } from 'vue'
import { useRouter } from 'vue-router'
import { NButton } from 'naive-ui'
import { supabase } from '@/lib/supabase'

const router = useRouter()
const branches = ref<any[]>([])
const loading = ref(false)
const pagination = { pageSize: 10 }

const goNew = () => router.push({ name: 'branch-new' })

const columns = [
  { title: 'ID', key: 'id', width: 250 },
  { title: '拠点名', key: 'name' },
  {
    title: '操作',
    key: 'actions',
    width: 200,
    render (row: any) {
      return h('div', {}, [
        h(
          NButton,
          {
            size: 'small',
            onClick: () => router.push({ name: 'branch-detail', params: { id: row.id } }),
            style: 'margin-right: 8px'
          },
          { default: () => '詳細' }
        ),
        h(
          NButton,
          {
            size: 'small',
            type: 'primary',
            onClick: () => router.push({ name: 'branch-edit', params: { id: row.id } })
          },
          { default: () => '編集' }
        )
      ])
    }
  }
]

const fetchBranches = async () => {
  loading.value = true
  const { data, error } = await supabase.from('branches').select('id, name')
  if (error) {
    console.error('fetchBranches error:', error)
  } else {
    branches.value = data || []
  }
  loading.value = false
}

onMounted(fetchBranches)
</script>```

## src/views/branches/BranchUpsert.vue

```vue
<template>
  <div class="p-4">
    <n-card :title="isEdit ? '拠点を編集' : '拠点を追加'">
      <!-- 編集時だけ読み取りメタを表示 -->
      <template v-if="isEdit && meta">
        <n-descriptions bordered label-placement="left" :column="2" class="mb-4">
          <n-descriptions-item label="ID">
            <code>{{ meta.id }}</code>
          </n-descriptions-item>
          <n-descriptions-item label="会社ID">
            <code v-if="form.company_id">{{ form.company_id }}</code>
            <span v-else>—</span>
          </n-descriptions-item>
          <n-descriptions-item label="作成日時">
            {{ formatTs(meta.created_at) }}
          </n-descriptions-item>
          <n-descriptions-item label="更新日時">
            {{ formatTs(meta.updated_at) }}
          </n-descriptions-item>
        </n-descriptions>
      </template>

      <n-form
        ref="formRef"
        :model="form"
        :rules="rules"
        label-placement="top"
        require-mark-placement="right-hanging"
        size="large"
      >
        <n-form-item label="拠点名" path="name">
          <n-input v-model:value="form.name" placeholder="例）カモミールハウス松本" clearable />
        </n-form-item>

        <n-form-item label="会社ID（任意）" path="company_id">
          <n-input v-model:value="form.company_id" placeholder="会社を区別する UUID 等（未設定可）" clearable />
        </n-form-item>

        <n-form-item label="状態" path="status">
          <n-select v-model:value="form.status" :options="statusOptions" placeholder="選択してください" clearable />
        </n-form-item>

        <n-form-item label="電話番号" path="phone">
          <n-input v-model:value="form.phone" placeholder="例）0263-xx-xxxx" clearable />
        </n-form-item>

        <n-form-item label="住所" path="address">
          <n-input v-model:value="form.address" placeholder="例）長野県松本市〜" clearable />
        </n-form-item>

        <n-form-item label="メモ" path="note">
          <n-input
            v-model:value="form.note"
            type="textarea"
            placeholder="備考やメモを入力"
            clearable
            :autosize="{ minRows: 3 }"
          />
        </n-form-item>

        <n-space justify="end">
          <n-button ghost @click="goList">キャンセル</n-button>
          <n-button type="primary" :loading="submitting" @click="save">保存</n-button>
        </n-space>
      </n-form>
    </n-card>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted, computed } from 'vue'
import { useRoute, useRouter } from 'vue-router'
import { useMessage } from 'naive-ui'
import { supabase } from '@/lib/supabase'
import { TABLE, ROUTE } from '@/lib/contracts'

type BranchForm = {
  id?: string
  name: string
  company_id: string | null
  status: string | null
  phone: string | null
  address: string | null
  note: string | null
}

type BranchMeta = {
  id: string
  created_at: string | null
  updated_at: string | null
}

const route = useRoute()
const router = useRouter()
const message = useMessage()

const formRef = ref()
const submitting = ref(false)
const isEdit = computed(() => !!route.params.id)

const form = ref<BranchForm>({
  name: '',
  company_id: null,
  status: 'active',
  phone: null,
  address: null,
  note: null
})

const meta = ref<BranchMeta | null>(null)

const statusOptions = [
  { label: 'active（有効）', value: 'active' },
  { label: 'inactive（一時停止）', value: 'inactive' },
  { label: 'disabled（無効化）', value: 'disabled' }
]

const rules = {
  name: { required: true, message: '拠点名は必須です', trigger: ['blur', 'input'] },
  status: { required: true, message: '状態を選択してください', trigger: ['change', 'blur'] }
}

function formatTs(iso?: string | null) {
  if (!iso) return '—'
  return new Date(iso).toLocaleString('ja-JP', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit'
  })
}

async function fetchBranch(id: string) {
  const { data, error } = await supabase
    .from(TABLE.branches)
    .select('id,name,company_id,status,phone,address,note,created_at,updated_at')
    .eq('id', id)
    .maybeSingle()

  if (error) {
    console.error('[BranchUpsert] fetch error:', error)
    message.error(error.message ?? '拠点の取得に失敗しました')
    return
  }
  if (!data) {
    message.warning('拠点が見つかりませんでした')
    return
  }

  form.value = {
    id: data.id,
    name: data.name ?? '',
    company_id: data.company_id ?? null,
    status: data.status ?? 'active',
    phone: data.phone ?? null,
    address: data.address ?? null,
    note: data.note ?? null
  }
  meta.value = {
    id: data.id,
    created_at: data.created_at ?? null,
    updated_at: data.updated_at ?? null
  }
}

async function save() {
  try {
    await formRef.value?.validate()
    submitting.value = true

    const payload = {
      name: form.value.name,
      company_id: form.value.company_id,
      status: form.value.status,
      phone: form.value.phone,
      address: form.value.address,
      note: form.value.note
    }

    if (isEdit.value && form.value.id) {
      const { error } = await supabase.from(TABLE.branches).update(payload).eq('id', form.value.id)
      if (error) throw error
      message.success('更新しました')
    } else {
      const { error } = await supabase.from(TABLE.branches).insert(payload)
      if (error) throw error
      message.success('追加しました')
    }

    goList()
  } catch (e: any) {
    console.error('[BranchUpsert] save error:', e)
    message.error(e?.message ?? '保存に失敗しました')
  } finally {
    submitting.value = false
  }
}

function goList() {
  router.push({ name: ROUTE.branches.name.list })
}

onMounted(() => {
  if (isEdit.value && typeof route.params.id === 'string') {
    fetchBranch(route.params.id)
  }
})
</script>

<style scoped>
.p-4 {
  padding: 1rem;
}
.mb-4 {
  margin-bottom: 1rem;
}
</style>```

## src/views/carelogs/CareLogDetail.vue

```vue
<script setup lang="ts">
import { ref, onMounted, computed } from 'vue'
import { useRoute, useRouter } from 'vue-router'
import { fromCare } from '@/lib/supabase'
import { TABLE } from '@/lib/contracts'
import {
  NCard, NDescriptions, NDescriptionsItem, NTag, NEmpty, NSpin,
  NButton, NSpace, NDivider
} from 'naive-ui'

type CareLog = {
  id: string
  date: string | null
  user_id: string | null
  staff_id: string | null
  branch_id: string | null
  title: string | null
  content: string | null
  summary?: string | null
  details?: string | null
  vitals_bp_systolic?: number | null
  vitals_bp_diastolic?: number | null
  vitals_hr?: number | null
  vitals_temp?: number | null
  meal?: string | null
  medication_given?: boolean
  medication_notes?: string | null
  toileting?: string | null
  mobility?: string | null
  mood?: string | null
  incident_flag?: boolean
  incident_notes?: string | null
  next_actions?: string | null
  tags?: string[]
  created_at?: string
  updated_at?: string
}

const route = useRoute()
const router = useRouter()

const loading = ref(false)
const log = ref<CareLog | null>(null)

const userName   = ref<string>('')
const staffName  = ref<string>('')
const branchName = ref<string>('')

const isLoaded = computed(() => !!log.value)

onMounted(async () => {
  await fetchDetail()
})

async function fetchDetail () {
  loading.value = true
  try {
    const id = String(route.params.id)
    // care_logs 本体
    const { data, error } = await fromCare(TABLE.careLogs)
      .select(`
        id, date, user_id, staff_id, branch_id,
        title, content, summary, details,
        vitals_bp_systolic, vitals_bp_diastolic, vitals_hr, vitals_temp,
        meal, medication_given, medication_notes,
        toileting, mobility, mood,
        incident_flag, incident_notes,
        next_actions,
        tags,
        created_at, updated_at
      `)
      .eq('id', id)
      .single()
    if (error) throw error
    log.value = data as CareLog

    // 関連の名前解決（RLS範囲内で取得）
    const [u, s, b] = await Promise.all([
      log.value?.user_id
        ? fromCare(TABLE.users).select('id, name').eq('id', log.value.user_id).maybeSingle()
        : Promise.resolve({ data: null, error: null }),
      log.value?.staff_id
        ? fromCare(TABLE.staffs).select('id, name').eq('id', log.value.staff_id).maybeSingle()
        : Promise.resolve({ data: null, error: null }),
      log.value?.branch_id
        ? fromCare(TABLE.branches).select('id, name').eq('id', log.value.branch_id).maybeSingle()
        : Promise.resolve({ data: null, error: null })
    ])

    userName.value   = (u as any)?.data?.name   ?? (log.value?.user_id   ?? '')
    staffName.value  = (s as any)?.data?.name   ?? (log.value?.staff_id  ?? '')
    branchName.value = (b as any)?.data?.name   ?? (log.value?.branch_id ?? '')
  } catch (e) {
    console.error(e)
  } finally {
    loading.value = false
  }
}

function goEdit () {
  if (!log.value?.id) return
  router.push({ name: 'care-log-edit', params: { id: log.value.id } })
}
</script>

<template>
  <div class="max-w-4xl">
    <n-card>
      <div class="flex items-center justify-between mb-2">
        <h1 class="text-lg font-semibold">ケアログ詳細</h1>
        <n-space>
          <n-button tertiary @click="$router.push({ name: 'care-log-list' })">一覧へ</n-button>
          <n-button type="primary" :disabled="!isLoaded" @click="goEdit">編集</n-button>
        </n-space>
      </div>

      <n-spin :show="loading">
        <n-descriptions
          v-if="log"
          label-placement="left"
          bordered
          :column="1"
        >
          <!-- 基本情報 -->
          <n-descriptions-item label="日付">
            {{ log.date || '—' }}
          </n-descriptions-item>
          <n-descriptions-item label="利用者">
            {{ userName || '—' }}
          </n-descriptions-item>
          <n-descriptions-item label="担当スタッフ">
            {{ staffName || '—' }}
          </n-descriptions-item>
          <n-descriptions-item label="拠点">
            {{ branchName || '—' }}
          </n-descriptions-item>

          <n-descriptions-item label="タイトル">
            {{ log.title || '—' }}
          </n-descriptions-item>
          <n-descriptions-item label="本文">
            <div class="whitespace-pre-wrap break-words">{{ log.content || '—' }}</div>
          </n-descriptions-item>

          <!-- まとめ/詳細 -->
          <n-descriptions-item label="サマリー">
            <div class="whitespace-pre-wrap break-words">{{ log.summary || '—' }}</div>
          </n-descriptions-item>
          <n-descriptions-item label="詳細メモ">
            <div class="whitespace-pre-wrap break-words">{{ log.details || '—' }}</div>
          </n-descriptions-item>

          <!-- バイタル -->
          <n-descriptions-item label="体温 (℃)">
            {{ (log.vitals_temp ?? '') !== '' && log.vitals_temp !== null ? log.vitals_temp : '—' }}
          </n-descriptions-item>
          <n-descriptions-item label="血圧 (mmHg)">
            <span v-if="(log.vitals_bp_systolic ?? null) !== null || (log.vitals_bp_diastolic ?? null) !== null">
              {{ log.vitals_bp_systolic ?? '—' }} / {{ log.vitals_bp_diastolic ?? '—' }}
            </span>
            <span v-else>—</span>
          </n-descriptions-item>
          <n-descriptions-item label="心拍数 (bpm)">
            {{ (log.vitals_hr ?? '') !== '' && log.vitals_hr !== null ? log.vitals_hr : '—' }}
          </n-descriptions-item>

          <!-- 生活系 -->
          <n-descriptions-item label="食事">
            <div class="whitespace-pre-wrap break-words">{{ log.meal || '—' }}</div>
          </n-descriptions-item>
          <n-descriptions-item label="投薬">
            <div class="flex flex-col gap-1">
              <div>実施: {{ log.medication_given ? 'あり' : 'なし' }}</div>
              <div v-if="log.medication_given">
                <div class="whitespace-pre-wrap break-words">
                  {{ log.medication_notes || '（記載なし）' }}
                </div>
              </div>
            </div>
          </n-descriptions-item>
          <n-descriptions-item label="排泄状況">
            <div class="whitespace-pre-wrap break-words">{{ log.toileting || '—' }}</div>
          </n-descriptions-item>
          <n-descriptions-item label="移動・ADL">
            <div class="whitespace-pre-wrap break-words">{{ log.mobility || '—' }}</div>
          </n-descriptions-item>
          <n-descriptions-item label="機嫌・様子">
            <div class="whitespace-pre-wrap break-words">{{ log.mood || '—' }}</div>
          </n-descriptions-item>

          <!-- インシデント -->
          <n-descriptions-item label="インシデント">
            <div class="flex flex-col gap-1">
              <div>発生: {{ log.incident_flag ? 'あり' : 'なし' }}</div>
              <div v-if="log.incident_flag">
                <div class="whitespace-pre-wrap break-words">
                  {{ log.incident_notes || '（記載なし）' }}
                </div>
              </div>
            </div>
          </n-descriptions-item>

          <!-- 次アクション -->
          <n-descriptions-item label="次アクション">
            <div class="whitespace-pre-wrap break-words">{{ log.next_actions || '—' }}</div>
          </n-descriptions-item>

          <!-- タグ -->
          <n-descriptions-item label="タグ">
            <div v-if="(log.tags?.length ?? 0) > 0" class="flex flex-wrap gap-2">
              <n-tag v-for="(t, i) in log.tags" :key="i" round>{{ t }}</n-tag>
            </div>
            <n-empty v-else description="タグなし" size="small" />
          </n-descriptions-item>

          <!-- システム -->
          <n-descriptions-item label="作成日時">
            {{ log.created_at || '—' }}
          </n-descriptions-item>
          <n-descriptions-item label="更新日時">
            {{ log.updated_at || '—' }}
          </n-descriptions-item>
          <n-descriptions-item label="ID">
            {{ log.id }}
          </n-descriptions-item>
        </n-descriptions>

        <n-empty v-else description="データが見つかりません" class="py-8" />
      </n-spin>
    </n-card>
  </div>
</template>

<style scoped>
/* 追加の見た目微調整があればここに */
</style>```

## src/views/carelogs/CareLogList.vue

```vue
<script setup lang="ts">
import { ref, onMounted, h, computed } from 'vue'
import { useRoute, useRouter } from 'vue-router'
import { fromCare } from '@/lib/supabase'
import { TABLE } from '@/lib/contracts'
import { NButton, NTag, NDataTable, NSpin } from 'naive-ui'

type Row = {
  id: string
  date: string
  title?: string
  summary?: string
  tags?: string[]
  branch_id?: string | null
  branch?: {
    id: string
    name?: string | null
    company?: {
      id: string
      name?: string | null
    } | null
  } | null
}

const route = useRoute()
const router = useRouter()

// /branch/:branchId/care-logs or ?branchId=... からの絞り込みに対応
const branchId = computed<string | undefined>(() => {
  return (route.params.branchId as string) || (route.query.branchId as string) || undefined
})

const loading = ref(false)
const rows = ref<Row[]>([])

async function fetchList () {
  loading.value = true
  try {
    // ネストで branch / company 名まで取得
    let q = fromCare(TABLE.careLogs)
      .select(`
        id,
        date,
        title,
        summary,
        tags,
        branch_id,
        branch:branches (
          id,
          name,
          company:companies (
            id,
            name
          )
        )
      `)
      .order('date', { ascending: false })

    if (branchId.value) {
      q = q.eq('branch_id', branchId.value)
    }

    const { data, error } = await q
    if (error) throw error
    rows.value = (data ?? []) as Row[]
  } finally {
    loading.value = false
  }
}

onMounted(fetchList)

// 先頭3件＋ "+n" 表示
function renderTags (row: Row) {
  const tags = Array.isArray(row.tags) ? row.tags : []
  if (tags.length === 0) return h('span', { style: 'color:#999' }, '—')

  const pills = tags.slice(0, 3).map((t, i) =>
    h(NTag, { round: true, key: i, style: 'margin-right:6px' }, { default: () => t })
  )
  const rest = tags.length - 3
  if (rest > 0) {
    pills.push(h(NTag, { round: true, bordered: false }, { default: () => `+${rest}` }))
  }
  return h('div', null, pills)
}

const columns = [
  { title: '日付', key: 'date', width: 120 },
  { title: 'タイトル', key: 'title', ellipsis: { tooltip: true }, minWidth: 200 },
  { title: '概要', key: 'summary', ellipsis: { tooltip: true }, minWidth: 260 },

  // ★ 追加：拠点名カラム
  {
    title: '拠点',
    key: 'branch_name',
    width: 200,
    render: (row: Row) => (row.branch?.name ?? '—')
  },
  {
    title: '操作',
    key: 'actions',
    width: 180,
    render: (row: Row) => h('div', null, [
      h(NButton, {
        size: 'small',
        tertiary: true,
        style: 'margin-right:8px',
        onClick: () => router.push({ name: 'care-log-detail', params: { id: row.id } })
      }, { default: () => '詳細' }),
      h(NButton, {
        size: 'small',
        onClick: () => router.push({ name: 'care-log-edit', params: { id: row.id } })
      }, { default: () => '編集' })
    ])
  }
]
</script>

<template>
  <div>
    <n-spin :show="loading">
      <n-data-table :columns="columns" :data="rows" :bordered="false" />
    </n-spin>
  </div>
</template>```

## src/views/carelogs/CareLogUpsert.vue

```vue
<script setup lang="ts">
import { ref, computed, onMounted } from 'vue'
import { useRoute, useRouter } from 'vue-router'
import { supabase, fromCare } from '@/lib/supabase'
import { TABLE } from '@/lib/contracts'
import { ymdStringToMs, msToYmdString } from '@/lib/date'
import { useImeGuard, pushUniqueTag } from '@/lib/utils'
import {
  NCard, NForm, NFormItem, NInput, NButton, NDatePicker,
  NSelect, NSpace, useMessage, NDynamicTags, NInputNumber, NSwitch
} from 'naive-ui'

// 追加の import
import { nextTick, onBeforeUnmount } from 'vue'
import type { InputInst } from 'naive-ui'

// 追記：NInput のインスタンス参照
const tagInputRef = ref<InputInst | null>(null)

// 追記：リスナーを保持して cleanup できるように
let removeTagInputListeners: (() => void) | null = null


type CareLogForm = {
  id?: string
  date: string | null
  user_id: string | null
  staff_id: string | null
  branch_id: string | null
  title: string | null
  content: string | null

  // 拡張フィールド
  summary?: string | null
  details?: string | null

  vitals_bp_systolic?: number | null
  vitals_bp_diastolic?: number | null
  vitals_hr?: number | null
  vitals_temp?: number | null

  meal?: string | null
  medication_given?: boolean
  medication_notes?: string | null
  toileting?: string | null
  mobility?: string | null
  mood?: string | null

  incident_flag?: boolean
  incident_notes?: string | null

  next_actions?: string | null

  // タグ
  tags?: string[]
}

const route = useRoute()
const router = useRouter()
const message = useMessage()

const id = route.params.id as string | undefined
const isEdit = computed(() => !!id)

const formRef = ref()
const submitting = ref(false)
const form = ref<CareLogForm>({
  date: null,
  user_id: null,
  staff_id: null,
  branch_id: null,
  title: '',
  content: '',

  summary: '',
  details: '',

  vitals_bp_systolic: null,
  vitals_bp_diastolic: null,
  vitals_hr: null,
  vitals_temp: null,

  meal: '',
  medication_given: false,
  medication_notes: '',

  toileting: '',
  mobility: '',
  mood: '',

  incident_flag: false,
  incident_notes: '',

  next_actions: '',

  tags: [] // ★ 初期化
})

const newTag = ref<string>('') // 追加入力欄
// const { onCompStart, onCompEnd, onEnter } = useImeGuard()
const { onCompStart, onCompEnd, onEnter, onBlur } = useImeGuard({ doubleEnterWindowMs: 800 })

function addTag () {
  form.value.tags = pushUniqueTag(form.value.tags ?? [], newTag.value)
  newTag.value = ''
}

// NDatePicker は number(unix ms) を扱うため、共通ユーティリティで相互変換（ローカル基準）
const dateValue = ref<number | null>(null)

// 選択肢
const branchOptions = ref<{ label: string; value: string }[]>([])
const staffOptions  = ref<{ label: string; value: string }[]>([])
const userOptions   = ref<{ label: string; value: string }[]>([])

async function loadOptions () {
  const [branches, staffs, users] = await Promise.all([
    fromCare(TABLE.branches).select('id, name'),
    fromCare(TABLE.staffs).select('id, name').order('id', { ascending: true }),
    fromCare(TABLE.users).select('id, name').order('id', { ascending: true })
  ])
  if (!branches.error) {
    branchOptions.value = (branches.data ?? [])
      .map(b => ({ label: (b as any).name ?? (b as any).id, value: (b as any).id }))
      .sort((a, b) => a.label.localeCompare(b.label, 'ja'))
  }
  if (!staffs.error) {
    staffOptions.value  = (staffs.data ?? [])
      .map(s => ({ label: (s as any).name ?? (s as any).id, value: (s as any).id }))
      .sort((a, b) => a.label.localeCompare(b.label, 'ja'))
  }
  if (!users.error) {
    userOptions.value   = (users.data ?? [])
      .map(u => ({ label: (u as any).name ?? (u as any).id, value: (u as any).id }))
      .sort((a, b) => a.label.localeCompare(b.label, 'ja'))
  }
}

async function loadExisting () {
  if (!isEdit.value) return
  const { data, error } = await fromCare(TABLE.careLogs)
    .select(`
      id, date, user_id, staff_id, branch_id, title, content,
      summary, details,
      vitals_bp_systolic, vitals_bp_diastolic, vitals_hr, vitals_temp,
      meal, medication_given, medication_notes,
      toileting, mobility, mood,
      incident_flag, incident_notes,
      next_actions,
      tags
    `)
    .eq('id', id!)
    .single()
  if (error) throw error

  form.value = {
    id: data!.id as string,
    date: (data as any).date ?? null,
    user_id: (data as any).user_id ?? null,
    staff_id: (data as any).staff_id ?? null,
    branch_id: (data as any).branch_id ?? null,
    title: (data as any).title ?? '',
    content: (data as any).content ?? '',

    summary: (data as any).summary ?? '',
    details: (data as any).details ?? '',

    vitals_bp_systolic:  (data as any).vitals_bp_systolic ?? null,
    vitals_bp_diastolic: (data as any).vitals_bp_diastolic ?? null,
    vitals_hr:           (data as any).vitals_hr ?? null,
    vitals_temp:         (data as any).vitals_temp ?? null,

    meal: (data as any).meal ?? '',
    medication_given: (data as any).medication_given ?? false,
    medication_notes: (data as any).medication_notes ?? '',

    toileting: (data as any).toileting ?? '',
    mobility:  (data as any).mobility ?? '',
    mood:      (data as any).mood ?? '',

    incident_flag:  (data as any).incident_flag ?? false,
    incident_notes: (data as any).incident_notes ?? '',

    next_actions: (data as any).next_actions ?? '',

    tags: Array.isArray((data as any).tags) ? (data as any).tags : []
  }
  dateValue.value = ymdStringToMs(form.value.date)
}

// 認証ユーザーの staff を自動紐付け（存在する場合のみ）
async function setMyStaffIfExists () {
  const { data: { user }, error } = await supabase.auth.getUser()
  if (error) {
    console.warn('[CareLogUpsert] getUser failed:', error)
    return
  }
  const myAuthUid = user?.id ?? null
  if (!myAuthUid) return

  const { data: s } = await fromCare(TABLE.staffs)
    .select('id, role')
    .eq('auth_user_id', myAuthUid)
    .maybeSingle()
  if (s?.id) {
    form.value.staff_id = s.id as string
  }
}

onMounted(async () => {
  try {
    await loadOptions()
    await setMyStaffIfExists()
    await loadExisting()
  } catch (e: any) {
    message.error(e?.message ?? '初期化に失敗しました')
  } finally {
    // ▼ ここから：内部 input 要素にネイティブでイベントを付与
    await nextTick()
    const el = tagInputRef.value?.inputElRef // ← Naive UI の内部 input要素
    if (el) {
      const handleKeyDown = (evt: KeyboardEvent) => {
        if (evt.key === 'Enter') onEnter(addTag)(evt) // utils のガードを通す
      }
      const handleCompStart = () => onCompStart()
      const handleCompEnd = () => onCompEnd()
      const handleBlur = () => onBlur()

      el.addEventListener('keydown', handleKeyDown)
      el.addEventListener('compositionstart', handleCompStart as any)
      el.addEventListener('compositionend', handleCompEnd as any)
      el.addEventListener('blur', handleBlur as any)

      removeTagInputListeners = () => {
        el.removeEventListener('keydown', handleKeyDown)
        el.removeEventListener('compositionstart', handleCompStart as any)
        el.removeEventListener('compositionend', handleCompEnd as any)
        el.removeEventListener('blur', handleBlur as any)
      }
    }
  }
})

// アンマウント時に後始末
onBeforeUnmount(() => {
  removeTagInputListeners?.()
  removeTagInputListeners = null
})

const rules = {
  date: { required: true, type: 'string', message: '日付は必須です', trigger: ['blur', 'change'] },
  user_id: { required: true, message: '利用者は必須です', trigger: ['blur', 'change'] },
  staff_id: { required: true, message: '担当は必須です', trigger: ['blur', 'change'] },
  branch_id: { required: true, message: '拠点は必須です', trigger: ['blur', 'change'] },
  title: { required: true, message: 'タイトルは必須です', trigger: ['blur', 'input'] },
  content: { required: true, message: '本文は必須です', trigger: ['blur', 'input'] }
}

async function save () {
  try {
    // dateValue(number) → form.date(YYYY-MM-DD)
    form.value.date = msToYmdString(dateValue.value)

    // 追加ガード（すり抜け防止）
    if (!form.value.user_id) { message.error('利用者を選択してください'); return }
    if (!form.value.staff_id) { message.error('担当スタッフを選択してください'); return }
    if (!form.value.branch_id) { message.error('拠点を選択してください'); return }

    // Naive UI の NForm でも検証
    await formRef.value?.validate()

    // ▼ tags を送信直前に正規化（IME確定の端数・空白などを除去）
    const normalizedTags: string[] = Array.isArray(form.value.tags)
      ? form.value.tags.map(t => String(t).trim()).filter(Boolean)
      : []

    submitting.value = true
    const payload = {
      date: form.value.date,
      user_id: form.value.user_id,
      staff_id: form.value.staff_id,
      branch_id: form.value.branch_id,
      title: form.value.title,
      content: form.value.content,
      summary: form.value.summary,
      details: form.value.details,

      vitals_bp_systolic:  form.value.vitals_bp_systolic,
      vitals_bp_diastolic: form.value.vitals_bp_diastolic,
      vitals_hr:           form.value.vitals_hr,
      vitals_temp:         form.value.vitals_temp,
      meal:                form.value.meal,
      medication_given:    form.value.medication_given,
      medication_notes:    form.value.medication_notes,
      toileting:           form.value.toileting,
      mobility:            form.value.mobility,
      mood:                form.value.mood,
      incident_flag:       form.value.incident_flag,
      incident_notes:      form.value.incident_notes,
      next_actions:        form.value.next_actions,

      // ★ 正規化済み tags を保存
      tags: normalizedTags
    }

    if (isEdit.value) {
      // ▼ 直後SELECTでDBに入ったtagsを取得して確認
      const { data, error } = await fromCare(TABLE.careLogs)
        .update(payload)
        .eq('id', form.value.id!)
        .select('id, tags')
        .single()

      if (error) throw error
      console.debug('[care_logs updated]', data)
      message.success(`更新しました（tags: ${data?.tags?.length ?? 0}件）`)
    } else {
      const { data, error } = await fromCare(TABLE.careLogs)
        .insert(payload)
        .select('id, tags')
        .single()

      if (error) throw error
      console.debug('[care_logs inserted]', data)
      message.success(`追加しました（tags: ${data?.tags?.length ?? 0}件）`)
    }

    router.push({ name: 'care-log-list' })
  } catch (e: any) {
    console.error(e)
    message.error(e?.message ?? '保存に失敗しました')
  } finally {
    submitting.value = false
  }
}
</script>

<template>
  <div class="max-w-3xl">
    <n-card>
      <div class="flex items-center justify-between mb-2">
        <h1 class="text-lg font-semibold">ケアログ{{ isEdit ? '編集' : '新規作成' }}</h1>
        <n-button tertiary @click="$router.push({ name: 'care-log-list' })">一覧へ</n-button>
      </div>

      <n-form ref="formRef" :model="form" :rules="rules" label-placement="top" size="large">
        <n-space vertical :size="18">

          <!-- タグ（IME対策付き） -->
          <n-form-item label="タグ" path="tags">
            <n-dynamic-tags
              v-model:value="form.tags"
              :separator="[' ', ',', '　', '、', '，']"
              placeholder="スペース/読点/カンマで確定"
            />
            <div class="mt-2 flex items-center gap-2">
              <n-input
                ref="tagInputRef"
                size="small"
                v-model:value="newTag"
                placeholder="タグを入力（日本語可）"
                class="max-w-[220px]"
              />
              <n-button size="small" @click="addTag">追加</n-button>
            </div>
          </n-form-item>

          <n-form-item label="日付" path="date">
            <n-date-picker
              v-model:value="dateValue"
              type="date"
              clearable
              style="width: 220px"
              @update:value="(v:number|null)=>{ dateValue=v; form.date = msToYmdString(v) }"
            />
          </n-form-item>

          <n-form-item label="利用者" path="user_id">
            <n-select
              v-model:value="form.user_id"
              :options="userOptions"
              filterable
              clearable
              placeholder="利用者を選択"
              style="max-width: 360px"
            />
          </n-form-item>

          <n-form-item label="担当" path="staff_id">
            <n-select
              v-model:value="form.staff_id"
              :options="staffOptions"
              filterable
              clearable
              placeholder="担当を選択"
              style="max-width: 360px"
            />
          </n-form-item>

          <n-form-item label="拠点" path="branch_id">
            <n-select
              v-model:value="form.branch_id"
              :options="branchOptions"
              filterable
              clearable
              placeholder="拠点を選択"
              style="max-width: 360px"
            />
          </n-form-item>

          <n-form-item label="タイトル" path="title">
            <n-input
              v-model:value="form.title"
              placeholder="短い見出し"
              clearable
              maxlength="120"
              show-count
            />
          </n-form-item>

          <n-form-item label="本文" path="content">
            <n-input
              v-model:value="form.content"
              type="textarea"
              placeholder="本文を入力"
              :autosize="{ minRows: 6, maxRows: 18 }"
            />
          </n-form-item>

          <n-form-item label="体温 (℃)" path="vitals_temp">
            <n-input-number v-model:value="form.vitals_temp" :precision="1" :step="0.1" min="30" max="45" placeholder="例: 36.8" />
          </n-form-item>

          <n-form-item label="血圧 (収縮期/拡張期 mmHg)" path="vitals_bp">
            <div class="flex gap-2">
              <n-input-number v-model:value="form.vitals_bp_systolic" :min="50" :max="250" placeholder="収縮期" />
              <n-input-number v-model:value="form.vitals_bp_diastolic" :min="30" :max="150" placeholder="拡張期" />
            </div>
          </n-form-item>

          <n-form-item label="心拍数 (bpm)" path="vitals_hr">
            <n-input-number v-model:value="form.vitals_hr" :min="20" :max="220" placeholder="例: 72" />
          </n-form-item>

          <n-form-item label="食事内容" path="meal">
            <n-input
              v-model:value="form.meal"
              type="textarea"
              placeholder="例: 朝食完食、昼食半分残し"
              clearable
            />
          </n-form-item>

          <n-form-item label="投薬" path="medication">
            <div class="flex flex-col gap-2">
              <n-switch v-model:value="form.medication_given">
                <template #checked>実施</template>
                <template #unchecked>なし</template>
              </n-switch>
              <n-input
                v-if="form.medication_given"
                v-model:value="form.medication_notes"
                placeholder="薬名・用量・副作用など"
                type="textarea"
              />
            </div>
          </n-form-item>

          <n-form-item label="排泄状況" path="toileting">
            <n-input
              v-model:value="form.toileting"
              placeholder="例: 便1回、尿4回、失禁なし"
              type="textarea"
            />
          </n-form-item>

          <n-form-item label="移動・ADL" path="mobility">
            <n-input
              v-model:value="form.mobility"
              placeholder="例: 自立歩行、移乗に介助要"
              type="textarea"
            />
          </n-form-item>

          <n-form-item label="機嫌・様子" path="mood">
            <n-input
              v-model:value="form.mood"
              placeholder="例: 機嫌良好、笑顔多い"
              type="textarea"
            />
          </n-form-item>

          <n-form-item label="インシデント（事故・ヒヤリ）" path="incident_flag">
            <div class="flex flex-col gap-2">
              <n-switch v-model:value="form.incident_flag">
                <template #checked>あり</template>
                <template #unchecked>なし</template>
              </n-switch>
              <n-input
                v-if="form.incident_flag"
                v-model:value="form.incident_notes"
                type="textarea"
                placeholder="内容を記載（例：トイレで軽い転倒。打撲なし、見守り強化）"
              />
            </div>
          </n-form-item>

          <div class="flex justify-end gap-2 pt-2">
            <n-button ghost @click="$router.push({ name: 'care-log-list' })">キャンセル</n-button>
            <n-button
              type="primary"
              :loading="submitting"
              :disabled="!form.user_id || !form.staff_id || !form.branch_id || !form.title || !form.content || !dateValue"
              @click="save"
            >
              保存
            </n-button>
          </div>
        </n-space>
      </n-form>
    </n-card>
  </div>
</template>```

## src/views/companies/CompanyDetail.vue

```vue
<!-- src/views/companies/CompanyDetail.vue -->
<template>
  <div class="p-4">
    <n-card :title="title">
      <template #header-extra>
        <n-space>
          <n-button quaternary @click="goList">一覧へ戻る</n-button>
          <n-button type="primary" @click="goEdit" :disabled="!companyId">編集</n-button>
        </n-space>
      </template>

      <n-descriptions
        v-if="row"
        label-placement="left"
        :column="1"
        bordered
        size="small"
      >
        <n-descriptions-item label="ID">
          <code class="break-all">{{ row.id }}</code>
        </n-descriptions-item>
        <n-descriptions-item label="会社名">
          {{ row.name || '—' }}
        </n-descriptions-item>
        <n-descriptions-item label="カナ">
          {{ row.kana || '—' }}
        </n-descriptions-item>
        <n-descriptions-item label="代表者">
          {{ row.daihyo || '—' }}
        </n-descriptions-item>
        <n-descriptions-item label="所在地">
          {{ row.addr || '—' }}
        </n-descriptions-item>
        <n-descriptions-item label="電話">
          {{ row.tel || '—' }}
        </n-descriptions-item>
        <n-descriptions-item label="作成日時">
          {{ formatDateTime(row.created_at) }}
        </n-descriptions-item>
      </n-descriptions>

      <div v-else class="py-6 text-center text-gray-500">
        データが見つかりませんでした
      </div>
    </n-card>
  </div>
</template>

<script setup lang="ts">
import { computed, onMounted, ref } from 'vue'
import { useRoute, useRouter } from 'vue-router'
import { useMessage, NCard, NSpace, NButton, NDescriptions, NDescriptionsItem } from 'naive-ui'
import { supabase } from '@/lib/supabase'
import { TABLE, ROUTE } from '@/lib/contracts'

const route = useRoute()
const router = useRouter()
const message = useMessage()

const companyId = computed(() => route.params.companyId as string | undefined)
const title = computed(() => '会社詳細')

type CompanyRow = {
  id: string
  name: string | null
  kana: string | null
  daihyo: string | null
  addr: string | null
  tel: string | null
  created_at: string | null
}

const row = ref<CompanyRow | null>(null)

function formatDateTime(v?: string | null) {
  if (!v) return '—'
  // 表示簡易化（ローカル時刻）
  try {
    const d = new Date(v)
    const yyyy = d.getFullYear()
    const mm = String(d.getMonth() + 1).padStart(2, '0')
    const dd = String(d.getDate()).padStart(2, '0')
    const hh = String(d.getHours()).padStart(2, '0')
    const mi = String(d.getMinutes()).padStart(2, '0')
    return `${yyyy}-${mm}-${dd} ${hh}:${mi}`
  } catch {
    return v
  }
}

async function load() {
  if (!companyId.value) return
  const { data, error } = await supabase
    .from(TABLE.companies)
    .select('id, name, kana, daihyo, addr, tel, created_at')
    .eq('id', companyId.value)
    .maybeSingle()

  if (error) {
    console.error('[CompanyDetail] fetch error:', error)
    message.error('会社情報の取得に失敗しました')
    return
  }
  row.value = (data as CompanyRow) ?? null
}

function goList() {
  router.push({ name: ROUTE.companies.name.list })
}
function goEdit() {
  if (!companyId.value) return
  router.push({ name: ROUTE.companies.name.edit, params: { companyId: companyId.value } })
}

onMounted(load)
</script>

<style scoped>
.p-4 { padding: 1rem; }
.break-all { word-break: break-all; }
.py-6 { padding-top: 1.5rem; padding-bottom: 1.5rem; }
.text-center { text-align: center; }
.text-gray-500 { color: #6b7280; }
</style>```

## src/views/companies/CompanyList.vue

```vue
<!-- src/views/companies/CompanyList.vue -->
<template>
  <div class="p-4">
    <n-card title="会社一覧">
      <template #header-extra>
        <n-button type="primary" @click="goNew">新規追加</n-button>
      </template>

      <n-data-table
        :columns="columns"
        :data="rows"
        :loading="loading"
        :pagination="pagination"
        :bordered="false"
      />
    </n-card>
  </div>
</template>

<script setup lang="ts">
import { h, ref, onMounted } from 'vue'
import { useRouter } from 'vue-router'
import { NButton, useMessage } from 'naive-ui'
import { supabase } from '@/lib/supabase'
import { TABLE, ROUTE } from '@/lib/contracts'

const router = useRouter()
const message = useMessage()

const rows = ref<any[]>([])
const loading = ref(false)

const pagination = {
  pageSize: 20,
  showSizePicker: false,
}

const columns = [
  { title: 'ID', key: 'id', width: 300 },
  { title: '会社名', key: 'name', width: 260 },
  { title: 'カナ', key: 'kana', width: 220 },
  { title: '代表者', key: 'daihyo', width: 160 },
  { title: '電話', key: 'tel', width: 140 },
  {
    title: '操作',
    key: 'actions',
    width: 220,
    render (row: any) {
      return h('div', { class: 'flex gap-2' }, [
        h(
          NButton,
          {
            size: 'small',
            onClick: () => router.push({ name: 'company-detail', params: { companyId: row.id } })
          },
          { default: () => '詳細' }
        ),
        h(
          NButton,
          {
            size: 'small',
            type: 'primary',
            onClick: () => router.push({ name: 'company-edit', params: { companyId: row.id } })
          },
          { default: () => '編集' }
        )
      ])
    }
  }
]

async function load() {
  loading.value = true
  try {
    // 今回は安全最小で必要カラムだけ
    const { data, error } = await supabase
      .from(TABLE.companies)
      .select('id, name, kana, daihyo, tel')
      .order('name', { ascending: true })
    if (error) throw error
    rows.value = data ?? []
  } catch (e: any) {
    console.error('[CompanyList] fetch error:', e)
    message.error(e?.message ?? '会社一覧の取得に失敗しました')
  } finally {
    loading.value = false
  }
}

function goNew() {
  router.push({ name: ROUTE.company.new })
}

onMounted(load)
</script>

<style scoped>
.p-4 { padding: 1rem; }
.flex { display: flex; }
.gap-2 { gap: 0.5rem; }
</style>```

## src/views/companies/CompanyUpsert.vue

```vue
<!-- src/views/companies/CompanyUpsert.vue -->
<template>
  <div class="p-4">
    <n-card :title="isEdit ? '会社編集' : '会社新規'">
      <n-form :model="form" :rules="rules" label-width="90">
        <n-form-item label="会社名" path="name">
          <n-input v-model:value="form.name" placeholder="例）株式会社コムレイド" />
        </n-form-item>
        <n-form-item label="カナ" path="kana">
          <n-input v-model:value="form.kana" placeholder="例）カブシキガイシャコムレイド" />
        </n-form-item>
        <n-form-item label="代表者" path="daihyo">
          <n-input v-model:value="form.daihyo" placeholder="例）山田 太郎" />
        </n-form-item>
        <n-form-item label="所在地" path="addr">
          <n-input v-model:value="form.addr" placeholder="例）松本市大字島立3803-1" />
        </n-form-item>
        <n-form-item label="電話" path="tel">
          <n-input v-model:value="form.tel" placeholder="例）0263-88-3906" />
        </n-form-item>

        <n-space>
          <n-button type="primary" :loading="saving" @click="onSave">
            {{ isEdit ? '更新' : '作成' }}
          </n-button>
          <n-button quaternary :disabled="saving" @click="goList">一覧へ戻る</n-button>
        </n-space>
      </n-form>
    </n-card>
  </div>
</template>

<script setup lang="ts">
import { onMounted, reactive, computed, ref } from 'vue'
import { useRoute, useRouter } from 'vue-router'
import { useMessage } from 'naive-ui'
import { supabase } from '@/lib/supabase'
import { TABLE } from '@/lib/contracts'

const route = useRoute()
const router = useRouter()
const message = useMessage()

const companyId = computed(() => route.params.companyId as string | undefined)
const isEdit = computed(() => !!companyId.value)

const form = reactive({
  name: '',
  kana: '',
  daihyo: '',
  addr: '',
  tel: ''
})

const rules = {
  name: { required: true, message: '会社名を入力してください', trigger: 'blur' }
}

const saving = ref(false)

async function load() {
  if (!isEdit.value) return
  const { data, error } = await supabase
    .from(TABLE.companies)
    .select('id, name, kana, daihyo, addr, tel')
    .eq('id', companyId.value)
    .maybeSingle()
  if (error) {
    console.error('[CompanyUpsert] load error:', error)
    message.error('会社情報の取得に失敗しました')
    return
  }
  if (data) {
    form.name = data.name ?? ''
    form.kana = data.kana ?? ''
    form.daihyo = data.daihyo ?? ''
    form.addr = data.addr ?? ''
    form.tel = data.tel ?? ''
  }
}

async function onSave() {
  // 多重送信防止
  if (saving.value) return
  try {
    saving.value = true

    if (isEdit.value) {
      // UPDATE: representation を要求しない（.select() を付けない）
      const { error: updErr } = await supabase
        .from(TABLE.companies)
        .update({
          name: form.name,
          kana: form.kana,
          daihyo: form.daihyo,
          addr: form.addr,
          tel: form.tel,
          updated_at: new Date().toISOString()
        })
        .eq('id', companyId.value)

      // PGRST116 対策：仮にどこかで &select=* が付いても成功として扱う
      if (updErr && updErr.code !== 'PGRST116') {
        throw updErr
      }

      message.success('更新しました')
    } else {
      // INSERT: IDが不要なら representation は要求しない
      const { error: insErr } = await supabase
        .from(TABLE.companies)
        .insert({
          name: form.name,
          kana: form.kana,
          daihyo: form.daihyo,
          addr: form.addr,
          tel: form.tel
        })
      if (insErr && insErr.code !== 'PGRST116') {
        throw insErr
      }
      message.success('作成しました')
    }

    goList()
  } catch (e: any) {
    console.error('[CompanyUpsert] save error:', e)
    message.error(e?.message ?? '保存に失敗しました')
  } finally {
    saving.value = false
  }
}

function goList() {
  router.push({ name: 'company-list' })
}

onMounted(load)
</script>

<style scoped>
.p-4 { padding: 1rem; }
</style>```

## src/views/staffs/StaffDetail.vue

```vue
<script setup lang="ts">
import { ref, onMounted, computed } from 'vue'
import { useRoute, useRouter } from 'vue-router'
import { fromCare } from '@/lib/supabase'
import { TABLE } from '@/lib/contracts'
// useMessage は自動化が不安定な環境があるため明示
import { useMessage } from 'naive-ui'

type Staff = {
  id: string
  name: string | null
  kana?: string | null
  birthdate?: string | null
  sex?: string | null
  phone?: string | null
  email?: string | null
  address?: string | null
  employment_type?: string | null
  hire_date?: string | null
  retire_date?: string | null
  department?: string | null
  title?: string | null
  qualification_tags?: string[] | null
  skill_tags?: string[] | null
  emergency_contact_name?: string | null
  emergency_contact_relation?: string | null
  emergency_contact_phone?: string | null
  availability_notes?: string | null
  training_notes?: string | null
  memo?: string | null
  photo_url?: string | null
  created_at?: string
  updated_at?: string
}

const route = useRoute()
const router = useRouter()
const message = useMessage()

const loading = ref(false)
const staff = ref<Staff | null>(null)
const isLoaded = computed(() => !!staff.value)

onMounted(fetchDetail)

async function fetchDetail () {
  loading.value = true
  try {
    const id = String(route.params.id)
    const { data, error } = await fromCare(TABLE.staffs)
      .select(`
        id, name, kana, birthdate, sex,
        phone, email, address,
        employment_type, hire_date, retire_date,
        department, title,
        qualification_tags, skill_tags,
        emergency_contact_name, emergency_contact_relation, emergency_contact_phone,
        availability_notes, training_notes, memo,
        photo_url,
        created_at, updated_at
      `)
      .eq('id', id)
      .single()
    if (error) throw error
    staff.value = data as Staff
  } catch (e:any) {
    console.error(e)
    message.error(e?.message ?? '読み込みに失敗しました')
  } finally {
    loading.value = false
  }
}

function goEdit () {
  if (!staff.value?.id) return
  router.push({ name: 'staff-edit', params: { id: staff.value.id } })
}
</script>

<template>
  <div class="max-w-4xl">
    <n-card>
      <div class="flex items-center justify-between mb-2">
        <h1 class="text-lg font-semibold">スタッフ詳細</h1>
        <n-space>
          <n-button tertiary @click="$router.push({ name: 'staff-list' })">一覧へ</n-button>
          <n-button type="primary" :disabled="!isLoaded" @click="goEdit">編集</n-button>
        </n-space>
      </div>

      <n-spin :show="loading">
        <template v-if="staff">
          <div class="mb-4">
            <n-image
              v-if="staff.photo_url"
              :src="staff.photo_url"
              width="120" height="120"
              class="rounded-xl object-cover"
            />
          </div>

          <n-divider>基本情報</n-divider>
          <n-descriptions label-placement="left" bordered :column="2">
            <n-descriptions-item label="氏名">{{ staff.name || '—' }}</n-descriptions-item>
            <n-descriptions-item label="カナ">{{ staff.kana || '—' }}</n-descriptions-item>
            <n-descriptions-item label="生年月日">{{ staff.birthdate || '—' }}</n-descriptions-item>
            <n-descriptions-item label="性別">{{ staff.sex || '—' }}</n-descriptions-item>
          </n-descriptions>

          <n-divider>連絡先</n-divider>
          <n-descriptions label-placement="left" bordered :column="2">
            <n-descriptions-item label="電話">{{ staff.phone || '—' }}</n-descriptions-item>
            <n-descriptions-item label="メール">{{ staff.email || '—' }}</n-descriptions-item>
            <n-descriptions-item label="住所"><div class="whitespace-pre-wrap">{{ staff.address || '—' }}</div></n-descriptions-item>
          </n-descriptions>

          <n-divider>雇用・所属</n-divider>
          <n-descriptions label-placement="left" bordered :column="2">
            <n-descriptions-item label="雇用形態">{{ staff.employment_type || '—' }}</n-descriptions-item>
            <n-descriptions-item label="入社日">{{ staff.hire_date || '—' }}</n-descriptions-item>
            <n-descriptions-item label="退職日">{{ staff.retire_date || '—' }}</n-descriptions-item>
            <n-descriptions-item label="部署">{{ staff.department || '—' }}</n-descriptions-item>
            <n-descriptions-item label="役職">{{ staff.title || '—' }}</n-descriptions-item>
          </n-descriptions>

          <n-divider>資格・スキル</n-divider>
          <n-descriptions label-placement="left" bordered :column="1">
            <n-descriptions-item label="資格">
              <div v-if="(staff.qualification_tags?.length ?? 0) > 0" class="flex flex-wrap gap-2">
                <n-tag v-for="(t,i) in staff.qualification_tags" :key="i" round>{{ t }}</n-tag>
              </div>
              <n-empty v-else size="small" description="未登録" />
            </n-descriptions-item>
            <n-descriptions-item label="スキル">
              <div v-if="(staff.skill_tags?.length ?? 0) > 0" class="flex flex-wrap gap-2">
                <n-tag v-for="(t,i) in staff.skill_tags" :key="i" round>{{ t }}</n-tag>
              </div>
              <n-empty v-else size="small" description="未登録" />
            </n-descriptions-item>
          </n-descriptions>

          <n-divider>緊急連絡先</n-divider>
          <n-descriptions label-placement="left" bordered :column="2">
            <n-descriptions-item label="氏名">{{ staff.emergency_contact_name || '—' }}</n-descriptions-item>
            <n-descriptions-item label="続柄">{{ staff.emergency_contact_relation || '—' }}</n-descriptions-item>
            <n-descriptions-item label="電話">{{ staff.emergency_contact_phone || '—' }}</n-descriptions-item>
          </n-descriptions>

          <n-divider>勤務・研修・メモ</n-divider>
          <n-descriptions label-placement="left" bordered :column="1">
            <n-descriptions-item label="出勤可能・希望">
              <div class="whitespace-pre-wrap">{{ staff.availability_notes || '—' }}</div>
            </n-descriptions-item>
            <n-descriptions-item label="研修履歴・資格更新">
              <div class="whitespace-pre-wrap">{{ staff.training_notes || '—' }}</div>
            </n-descriptions-item>
            <n-descriptions-item label="メモ">
              <div class="whitespace-pre-wrap">{{ staff.memo || '—' }}</div>
            </n-descriptions-item>
          </n-descriptions>

          <n-divider>システム</n-divider>
          <n-descriptions label-placement="left" bordered :column="2">
            <n-descriptions-item label="作成日時">{{ staff.created_at || '—' }}</n-descriptions-item>
            <n-descriptions-item label="更新日時">{{ staff.updated_at || '—' }}</n-descriptions-item>
            <n-descriptions-item label="ID">{{ staff.id }}</n-descriptions-item>
          </n-descriptions>
        </template>

        <n-empty v-else description="データが見つかりません" class="py-8" />
      </n-spin>
    </n-card>
  </div>
</template>```

## src/views/staffs/StaffList.vue

```vue
<script setup lang="ts">
import { ref, onMounted, h } from 'vue'
import { useRouter } from 'vue-router'
import { fromCare } from '@/lib/supabase'
import { TABLE } from '@/lib/contracts'
import { NDataTable, NSpin, NButton, NTag } from 'naive-ui'

type BranchMini = { id: string; name: string | null }
type Row = {
  id: string
  name: string
  role?: 'superadmin' | 'admin' | 'manager' | string | null
  email?: string | null
  staff_branch_memberships?: Array<{ branch: BranchMini | null }> | null
}

const router = useRouter()
const loading = ref(false)
const rows = ref<Row[]>([])

async function fetchList () {
  loading.value = true
  try {
    const { data, error } = await fromCare(TABLE.staffs)
      .select(`
        id,
        name,
        role,
        email,
        staff_branch_memberships:staff_branch_memberships (
          branch:branches (
            id,
            name
          )
        )
      `)
      .order('name', { ascending: true })

    if (error) throw error
    rows.value = (data ?? []) as Row[]
  } finally {
    loading.value = false
  }
}

onMounted(fetchList)

function renderBranches (row: Row) {
  const list = (row.staff_branch_memberships ?? [])
    .map(m => m?.branch?.name)
    .filter(Boolean) as string[]

  if (list.length === 0) return h('span', { style: 'color:#999' }, '—')

  const pills = list.slice(0, 3).map((name, i) =>
    h(NTag, { round: true, key: i, style: 'margin-right:6px' }, { default: () => name })
  )
  const rest = list.length - 3
  if (rest > 0) pills.push(h(NTag, { round: true, bordered: false }, { default: () => `+${rest}` }))
  return h('div', null, pills)
}

const columns = [
  { title: '氏名', key: 'name', minWidth: 160 },
  { title: '役割', key: 'role', width: 120 },
  { title: 'メール', key: 'email', minWidth: 200, ellipsis: { tooltip: true } },
  { title: '所属拠点', key: 'branches', minWidth: 260, render: (row: Row) => renderBranches(row) },
  {
    title: '操作',
    key: 'actions',
    width: 200,
    render: (row: Row) => h('div', null, [
      h(NButton, {
        size: 'small',
        tertiary: true,
        style: 'margin-right:8px',
        onClick: () => router.push({ name: 'staff-detail', params: { id: row.id } })
      }, { default: () => '詳細' }),
      h(NButton, {
        size: 'small',
        onClick: () => router.push({ name: 'staff-edit', params: { id: row.id } })
      }, { default: () => '編集' })
    ])
  }
]
</script>

<template>
  <div>
    <n-spin :show="loading">
      <n-data-table :columns="columns" :data="rows" :bordered="false" />
    </n-spin>
  </div>
</template>```

## src/views/staffs/StaffUpsert.vue

```vue
<script setup lang="ts">
import { ref, computed, onMounted, nextTick, onBeforeUnmount } from 'vue'
import { useRoute, useRouter } from 'vue-router'
import { fromCare } from '@/lib/supabase'
import { TABLE } from '@/lib/contracts'
import { useImeGuard, pushUniqueTag } from '@/lib/utils'
import { useMessage } from 'naive-ui'
import type { InputInst } from 'naive-ui'

type StaffForm = {
  id?: string
  name: string
  kana?: string | null
  birthdate?: string | null
  sex?: string | null
  phone?: string | null
  email?: string | null
  address?: string | null
  employment_type?: string | null
  hire_date?: string | null
  retire_date?: string | null
  department?: string | null
  title?: string | null
  qualification_tags?: string[]
  skill_tags?: string[]
  emergency_contact_name?: string | null
  emergency_contact_relation?: string | null
  emergency_contact_phone?: string | null
  availability_notes?: string | null
  training_notes?: string | null
  memo?: string | null
  photo_url?: string | null
}

const route = useRoute()
const router = useRouter()
const message = useMessage()

const id = route.params.id as string | undefined
const isEdit = computed(() => !!id)

const formRef = ref()
const submitting = ref(false)
const form = ref<StaffForm>({
  name: '',
  kana: '',
  birthdate: '',
  sex: '',
  phone: '',
  email: '',
  address: '',
  employment_type: '',
  hire_date: '',
  retire_date: '',
  department: '',
  title: '',
  qualification_tags: [],
  skill_tags: [],
  emergency_contact_name: '',
  emergency_contact_relation: '',
  emergency_contact_phone: '',
  availability_notes: '',
  training_notes: '',
  memo: '',
  photo_url: ''
})

const rules = {
  name: { required: true, message: '氏名は必須です', trigger: ['blur', 'input'] }
}

/* ------------ 所属拠点（multiple） -------------- */
type Option = { label: string; value: string }
const branchOptions = ref<Option[]>([])
const selectedBranchIds = ref<string[]>([])

async function loadBranchOptions () {
  const { data, error } = await fromCare(TABLE.branches)
    .select('id, name')
    .order('name', { ascending: true })
  if (error) throw error
  branchOptions.value = (data ?? []).map((b: any) => ({
    label: b?.name ?? b?.id,
    value: b?.id
  }))
}

/* --------- IMEガード（2回Enterで追加：資格/スキル用） --------- */
const { onCompStart, onCompEnd, onEnter, onBlur } = useImeGuard({ doubleEnterWindowMs: 800, suppressAfterCompMs: 60 })
const qInputRef = ref<InputInst | null>(null)  // 資格
const sInputRef = ref<InputInst | null>(null)  // スキル
const newQTag = ref('')
const newSTag = ref('')
let removeQListeners: (() => void) | null = null
let removeSListeners: (() => void) | null = null

function addQual () {
  form.value.qualification_tags = pushUniqueTag(form.value.qualification_tags, newQTag.value)
  newQTag.value = ''
}
function addSkill () {
  form.value.skill_tags = pushUniqueTag(form.value.skill_tags, newSTag.value)
  newSTag.value = ''
}

async function bindNative () {
  await nextTick()
  const bind = (inst: InputInst | null, addFn: () => void) => {
    const el = inst?.inputElRef
    if (!el) return () => {}

    const handleKeyDown   = (evt: KeyboardEvent) => { if (evt.key === 'Enter') onEnter(addFn)(evt) }
    const handleCompStart = () => onCompStart()
    const handleCompEnd   = () => onCompEnd()
    const handleBlurEv    = () => onBlur()

    el.addEventListener('keydown', handleKeyDown)
    el.addEventListener('compositionstart', handleCompStart as any)
    el.addEventListener('compositionend', handleCompEnd as any)
    el.addEventListener('blur', handleBlurEv as any)

    return () => {
      el.removeEventListener('keydown', handleKeyDown)
      el.removeEventListener('compositionstart', handleCompStart as any)
      el.removeEventListener('compositionend', handleCompEnd as any)
      el.removeEventListener('blur', handleBlurEv as any)
    }
  }
  removeQListeners = bind(qInputRef.value, addQual)
  removeSListeners = bind(sInputRef.value, addSkill)
}

onBeforeUnmount(() => {
  removeQListeners?.()
  removeSListeners?.()
  removeQListeners = removeSListeners = null
})

/* -------------- 初期読み込み --------------- */
onMounted(async () => {
  try {
    // 拠点選択肢 → スタッフ本体/所属
    await loadBranchOptions()
    await loadExisting()
    await bindNative()
  } catch (e:any) {
    console.error(e)
    message.error(e?.message ?? '初期化に失敗しました')
  }
})

async function loadExisting () {
  if (!isEdit.value) return
  try {
    // スタッフ本体
    const { data, error } = await fromCare(TABLE.staffs)
      .select(`
        id, name, kana, birthdate, sex,
        phone, email, address,
        employment_type, hire_date, retire_date,
        department, title,
        qualification_tags, skill_tags,
        emergency_contact_name, emergency_contact_relation, emergency_contact_phone,
        availability_notes, training_notes, memo,
        photo_url
      `)
      .eq('id', id!)
      .single()
    if (error) throw error
    form.value = {
      ...(data as any),
      qualification_tags: Array.isArray((data as any).qualification_tags) ? (data as any).qualification_tags : [],
      skill_tags: Array.isArray((data as any).skill_tags) ? (data as any).skill_tags : []
    }

    // 所属拠点（membership）
    const { data: mems, error: mErr } = await fromCare(TABLE.staffBranchMemberships)
      .select('branch_id')
      .eq('staff_id', id!)
    if (mErr) throw mErr
    selectedBranchIds.value = (mems ?? []).map((m: any) => m.branch_id).filter(Boolean)
  } catch (e:any) {
    throw e
  }
}

/* ---------------- 保存処理（差分同期） ---------------- */
async function save () {
  try {
    await formRef.value?.validate()
    submitting.value = true

    // 本体ペイロード正規化
    const payload: StaffForm = {
      ...form.value,
      qualification_tags: (form.value.qualification_tags ?? []).map(t => String(t).trim()).filter(Boolean),
      skill_tags: (form.value.skill_tags ?? []).map(t => String(t).trim()).filter(Boolean)
    }

    // 1) 本体 INSERT/UPDATE
    let staffId = form.value.id as string | undefined
    if (isEdit.value) {
      const { error } = await fromCare(TABLE.staffs).update(payload).eq('id', staffId!)
      if (error) throw error
    } else {
      const { data, error } = await fromCare(TABLE.staffs)
        .insert(payload)
        .select('id')
        .single()
      if (error) throw error
      staffId = (data as any)?.id
      form.value.id = staffId
    }

    if (!staffId) {
      throw new Error('スタッフIDの解決に失敗しました')
    }

    // 2) 既存 membership を取得
    const { data: currentMems, error: curErr } = await fromCare(TABLE.staffBranchMemberships)
      .select('branch_id')
      .eq('staff_id', staffId)
    if (curErr) throw curErr
    const currentIds = new Set<string>((currentMems ?? []).map((m:any) => m.branch_id))

    // 3) 差分算出
    const nextIds = new Set<string>(selectedBranchIds.value ?? [])
    const toAdd: string[] = []
    const toRemove: string[] = []
    nextIds.forEach(id => { if (!currentIds.has(id)) toAdd.push(id) })
    currentIds.forEach(id => { if (!nextIds.has(id)) toRemove.push(id) })

    // 4) 追加
    if (toAdd.length > 0) {
      const rows = toAdd.map(bid => ({ staff_id: staffId!, branch_id: bid }))
      const { error: addErr } = await fromCare(TABLE.staffBranchMemberships).insert(rows)
      if (addErr) throw addErr
    }

    // 5) 削除
    if (toRemove.length > 0) {
      const { error: delErr } = await fromCare(TABLE.staffBranchMemberships)
        .delete()
        .eq('staff_id', staffId)
        .in('branch_id', toRemove)
      if (delErr) throw delErr
    }

    message.success(isEdit.value ? '更新しました' : '追加しました')
    router.push({ name: 'staff-list' })
  } catch (e:any) {
    console.error(e)
    message.error(e?.message ?? '保存に失敗しました')
  } finally {
    submitting.value = false
  }
}
</script>

<template>
  <div class="max-w-4xl">
    <n-card>
      <div class="flex items-center justify-between mb-2">
        <h1 class="text-lg font-semibold">スタッフ{{ isEdit ? '編集' : '新規登録' }}</h1>
        <n-button tertiary @click="$router.push({ name: 'staff-list' })">一覧へ</n-button>
      </div>

      <n-form ref="formRef" :model="form" :rules="rules" label-placement="top">
        <n-divider>基本情報</n-divider>
        <n-form-item label="氏名" path="name"><n-input v-model:value="form.name" clearable /></n-form-item>
        <n-form-item label="カナ" path="kana"><n-input v-model:value="form.kana" clearable /></n-form-item>
        <n-form-item label="生年月日 (YYYY-MM-DD)" path="birthdate"><n-input v-model:value="form.birthdate" clearable /></n-form-item>
        <n-form-item label="性別" path="sex"><n-input v-model:value="form.sex" placeholder="例: male/female/other" /></n-form-item>

        <n-divider>連絡先</n-divider>
        <n-form-item label="電話" path="phone"><n-input v-model:value="form.phone" clearable /></n-form-item>
        <n-form-item label="メール" path="email"><n-input v-model:value="form.email" clearable /></n-form-item>
        <n-form-item label="住所" path="address"><n-input v-model:value="form.address" type="textarea" :autosize="{minRows:2, maxRows:4}" /></n-form-item>

        <n-divider>雇用・所属</n-divider>
        <n-form-item label="雇用形態" path="employment_type"><n-input v-model:value="form.employment_type" placeholder="例: 常勤/非常勤 など" /></n-form-item>
        <n-form-item label="入社日" path="hire_date"><n-input v-model:value="form.hire_date" placeholder="YYYY-MM-DD" /></n-form-item>
        <n-form-item label="退職日" path="retire_date"><n-input v-model:value="form.retire_date" placeholder="YYYY-MM-DD" /></n-form-item>
        <n-form-item label="部署" path="department"><n-input v-model:value="form.department" /></n-form-item>
        <n-form-item label="役職" path="title"><n-input v-model:value="form.title" /></n-form-item>

        <!-- 所属拠点（複数選択） -->
        <n-form-item label="所属拠点" path="branches">
          <n-select
            v-model:value="selectedBranchIds"
            :options="branchOptions"
            multiple
            placeholder="所属する拠点を選択"
            clearable
            filterable
            style="max-width: 520px"
          />
        </n-form-item>

        <n-divider>資格・スキル</n-divider>
        <n-form-item label="資格（タグ）" path="qualification_tags">
          <n-dynamic-tags v-model:value="form.qualification_tags" />
          <div class="mt-2 flex items-center gap-2">
            <n-input ref="qInputRef" size="small" v-model:value="newQTag" placeholder="例: 介護福祉士 / 看護師" class="max-w-[260px]" />
            <n-button size="small" @click="addQual">追加</n-button>
          </div>
        </n-form-item>
        <n-form-item label="スキル（タグ）" path="skill_tags">
          <n-dynamic-tags v-model:value="form.skill_tags" />
          <div class="mt-2 flex items-center gap-2">
            <n-input ref="sInputRef" size="small" v-model:value="newSTag" placeholder="例: 認知症ケア / 送迎" class="max-w-[260px]" />
            <n-button size="small" @click="addSkill">追加</n-button>
          </div>
        </n-form-item>

        <n-divider>緊急連絡先</n-divider>
        <n-form-item label="氏名" path="emergency_contact_name"><n-input v-model:value="form.emergency_contact_name" /></n-form-item>
        <n-form-item label="続柄" path="emergency_contact_relation"><n-input v-model:value="form.emergency_contact_relation" /></n-form-item>
        <n-form-item label="電話" path="emergency_contact_phone"><n-input v-model:value="form.emergency_contact_phone" /></n-form-item>

        <n-divider>勤務・研修・メモ</n-divider>
        <n-form-item label="出勤可能・希望" path="availability_notes"><n-input v-model:value="form.availability_notes" type="textarea" :autosize="{minRows:2, maxRows:4}" /></n-form-item>
        <n-form-item label="研修履歴・資格更新" path="training_notes"><n-input v-model:value="form.training_notes" type="textarea" :autosize="{minRows:2, maxRows:4}" /></n-form-item>
        <n-form-item label="メモ" path="memo"><n-input v-model:value="form.memo" type="textarea" :autosize="{minRows:2, maxRows:6}" /></n-form-item>

        <div class="flex justify-end gap-2 pt-2">
          <n-button ghost @click="$router.push({ name: 'staff-list' })">キャンセル</n-button>
          <n-button type="primary" :loading="submitting" @click="save">保存</n-button>
        </div>
      </n-form>
    </n-card>
  </div>
</template>```

## src/views/users/UserDetail.vue

```vue
<script setup lang="ts">
import { ref, onMounted } from 'vue'
import { useRoute, useRouter } from 'vue-router'
import { fromCare } from '@/lib/supabase'
import { TABLE } from '@/lib/contracts'
import {
  NCard, NDescriptions, NDescriptionsItem, NTag, NEmpty, NSpin,
  NButton, NSpace, NDivider, NImage
} from 'naive-ui'

type User = {
  id: string
  name: string | null
  kana?: string | null
  birthdate?: string | null
  sex?: string | null
  phone?: string | null
  address?: string | null
  emergency_contact_name?: string | null
  emergency_contact_relation?: string | null
  emergency_contact_phone?: string | null
  allergies?: string[] | null
  diagnoses?: string[] | null
  medications?: string | null
  care_level?: string | null
  care_insurance_id?: string | null
  physician_name?: string | null
  physician_clinic?: string | null
  physician_phone?: string | null
  diet?: string | null
  swallowing_caution?: string | null
  fall_risk?: boolean | null
  dementia_stage?: string | null
  mobility?: string | null
  adl_notes?: string | null
  preferences?: string | null
  communication_notes?: string | null
  photo_url?: string | null
  created_at?: string
  updated_at?: string
}

const route = useRoute()
const router = useRouter()
const loading = ref(false)
const user = ref<User | null>(null)

onMounted(fetchDetail)

async function fetchDetail () {
  loading.value = true
  try {
    const id = String(route.params.id)
    const { data, error } = await fromCare(TABLE.users)
      .select(`
        id, name, kana, birthdate, sex,
        phone, address,
        emergency_contact_name, emergency_contact_relation, emergency_contact_phone,
        allergies, diagnoses, medications,
        care_level, care_insurance_id,
        physician_name, physician_clinic, physician_phone,
        diet, swallowing_caution,
        fall_risk, dementia_stage,
        mobility, adl_notes,
        preferences, communication_notes,
        photo_url,
        created_at, updated_at
      `)
      .eq('id', id)
      .single()
    if (error) throw error
    user.value = data as User
  } catch (e) {
    console.error(e)
  } finally {
    loading.value = false
  }
}

function goEdit () {
  if (!user.value?.id) return
  router.push({ name: 'user-edit', params: { id: user.value.id } })
}
</script>

<template>
  <div class="max-w-4xl">
    <n-card>
      <div class="flex items-center justify-between mb-2">
        <h1 class="text-lg font-semibold">利用者プロフィール</h1>
        <n-space>
          <n-button tertiary @click="$router.push({ name: 'user-list' })">一覧へ</n-button>
          <n-button type="primary" :disabled="!user" @click="goEdit">編集</n-button>
        </n-space>
      </div>

      <n-spin :show="loading">
        <template v-if="user">
          <!-- 画像 -->
          <div class="mb-4">
            <n-image
              v-if="user.photo_url"
              :src="user.photo_url"
              width="120"
              height="120"
              :preview-disabled="false"
              class="rounded-xl object-cover"
            />
          </div>

          <!-- 基本情報 -->
          <n-divider>基本情報</n-divider>
          <n-descriptions label-placement="left" bordered :column="2">
            <n-descriptions-item label="氏名">{{ user.name || '—' }}</n-descriptions-item>
            <n-descriptions-item label="カナ">{{ user.kana || '—' }}</n-descriptions-item>
            <n-descriptions-item label="生年月日">{{ user.birthdate || '—' }}</n-descriptions-item>
            <n-descriptions-item label="性別">{{ user.sex || '—' }}</n-descriptions-item>
          </n-descriptions>

          <!-- 連絡先 -->
          <n-divider>連絡先</n-divider>
          <n-descriptions label-placement="left" bordered :column="2">
            <n-descriptions-item label="電話">{{ user.phone || '—' }}</n-descriptions-item>
            <n-descriptions-item label="住所"><div class="whitespace-pre-wrap">{{ user.address || '—' }}</div></n-descriptions-item>
          </n-descriptions>

          <!-- 緊急連絡先 -->
          <n-divider>緊急連絡先</n-divider>
          <n-descriptions label-placement="left" bordered :column="2">
            <n-descriptions-item label="氏名">{{ user.emergency_contact_name || '—' }}</n-descriptions-item>
            <n-descriptions-item label="続柄">{{ user.emergency_contact_relation || '—' }}</n-descriptions-item>
            <n-descriptions-item label="電話">{{ user.emergency_contact_phone || '—' }}</n-descriptions-item>
          </n-descriptions>

          <!-- 医療情報 -->
          <n-divider>医療情報</n-divider>
          <n-descriptions label-placement="left" bordered :column="1">
            <n-descriptions-item label="アレルギー">
              <div v-if="(user.allergies?.length ?? 0) > 0" class="flex flex-wrap gap-2">
                <n-tag v-for="(t, i) in user.allergies" :key="i" round>{{ t }}</n-tag>
              </div>
              <n-empty v-else description="なし" size="small" />
            </n-descriptions-item>
            <n-descriptions-item label="既往・診断名">
              <div v-if="(user.diagnoses?.length ?? 0) > 0" class="flex flex-wrap gap-2">
                <n-tag v-for="(d, i) in user.diagnoses" :key="i" round>{{ d }}</n-tag>
              </div>
              <n-empty v-else description="未登録" size="small" />
            </n-descriptions-item>
            <n-descriptions-item label="内服・処方">
              <div class="whitespace-pre-wrap">{{ user.medications || '—' }}</div>
            </n-descriptions-item>
          </n-descriptions>

          <!-- 介護保険 -->
          <n-divider>介護保険</n-divider>
          <n-descriptions label-placement="left" bordered :column="2">
            <n-descriptions-item label="要介護区分">{{ user.care_level || '—' }}</n-descriptions-item>
            <n-descriptions-item label="被保険者番号">{{ user.care_insurance_id || '—' }}</n-descriptions-item>
          </n-descriptions>

          <!-- 主治医 -->
          <n-divider>主治医</n-divider>
          <n-descriptions label-placement="left" bordered :column="2">
            <n-descriptions-item label="氏名">{{ user.physician_name || '—' }}</n-descriptions-item>
            <n-descriptions-item label="医療機関">{{ user.physician_clinic || '—' }}</n-descriptions-item>
            <n-descriptions-item label="電話">{{ user.physician_phone || '—' }}</n-descriptions-item>
          </n-descriptions>

          <!-- 食事・嚥下 -->
          <n-divider>食事・嚥下</n-divider>
          <n-descriptions label-placement="left" bordered :column="2">
            <n-descriptions-item label="食形態">{{ user.diet || '—' }}</n-descriptions-item>
            <n-descriptions-item label="嚥下注意点"><div class="whitespace-pre-wrap">{{ user.swallowing_caution || '—' }}</div></n-descriptions-item>
          </n-descriptions>

          <!-- リスク・認知 -->
          <n-divider>リスク・認知</n-divider>
          <n-descriptions label-placement="left" bordered :column="2">
            <n-descriptions-item label="転倒リスク">{{ user.fall_risk ? 'あり' : (user.fall_risk === false ? 'なし' : '—') }}</n-descriptions-item>
            <n-descriptions-item label="認知症ステージ">{{ user.dementia_stage || '—' }}</n-descriptions-item>
          </n-descriptions>

          <!-- 生活・ADL -->
          <n-divider>生活・ADL</n-divider>
          <n-descriptions label-placement="left" bordered :column="1">
            <n-descriptions-item label="移動・補助具など"><div class="whitespace-pre-wrap">{{ user.mobility || '—' }}</div></n-descriptions-item>
            <n-descriptions-item label="ADLメモ"><div class="whitespace-pre-wrap">{{ user.adl_notes || '—' }}</div></n-descriptions-item>
          </n-descriptions>

          <!-- 好み・配慮 -->
          <n-divider>好み・配慮</n-divider>
          <n-descriptions label-placement="left" bordered :column="1">
            <n-descriptions-item label="好み・NG"><div class="whitespace-pre-wrap">{{ user.preferences || '—' }}</div></n-descriptions-item>
            <n-descriptions-item label="伝達・配慮事項"><div class="whitespace-pre-wrap">{{ user.communication_notes || '—' }}</div></n-descriptions-item>
          </n-descriptions>

          <!-- システム -->
          <n-divider>システム</n-divider>
          <n-descriptions label-placement="left" bordered :column="2">
            <n-descriptions-item label="作成日時">{{ user.created_at || '—' }}</n-descriptions-item>
            <n-descriptions-item label="更新日時">{{ user.updated_at || '—' }}</n-descriptions-item>
            <n-descriptions-item label="ID">{{ user.id }}</n-descriptions-item>
          </n-descriptions>
        </template>

        <n-empty v-else description="データが見つかりません" class="py-8" />
      </n-spin>
    </n-card>
  </div>
</template>```

## src/views/users/UserList.vue

```vue
<script setup lang="ts">
import { ref, onMounted, h } from 'vue'
import { useRouter } from 'vue-router'
import { fromCare } from '@/lib/supabase'
import { TABLE } from '@/lib/contracts'
import { NDataTable, NSpin, NButton, NTag } from 'naive-ui'

type BranchMini = { id: string; name: string | null }
type Row = {
  id: string
  name: string
  kana?: string | null
  status?: string | null
  company_id?: string | null
  user_branch_memberships?: Array<{ branch: BranchMini | null }> | null
}

const router = useRouter()
const loading = ref(false)
const rows = ref<Row[]>([])

import { useAuthStore } from '@/stores/auth'
const auth = useAuthStore()

async function fetchList () {
  loading.value = true
  try {
    const { data, error } = await supabase
      .from('users')
      .select(`
        id,
        name,
        kana,
        status,
        company_id,
        user_branch_memberships:user_branch_memberships (
          branch:branches (
            id,
            name
          )
        )
      `)
      .eq('company_id', auth.companyId) // ← ここが連動ポイント
      .order('name', { ascending: true })

    if (error) throw error
    rows.value = (data ?? []) as Row[]
  } finally {
    loading.value = false
  }
}

onMounted(fetchList)

function renderBranches (row: Row) {
  const list = (row.user_branch_memberships ?? [])
    .map(m => m?.branch?.name)
    .filter(Boolean) as string[]

  if (list.length === 0) {
    return h(NTag, {
      round: true,
      type: 'warning',
      style: 'color:#999;background:#fffbe6;border-color:#ffe58f'
    }, { default: () => '未所属' })
  }

  const pills = list.slice(0, 3).map((name, i) =>
    h(NTag, { round: true, key: i, style: 'margin-right:6px' }, { default: () => name })
  )
  const rest = list.length - 3
  if (rest > 0) pills.push(h(NTag, { round: true, bordered: false }, { default: () => `+${rest}` }))
  return h('div', null, pills)
}

const columns = [
  { title: '氏名', key: 'name', minWidth: 160 },
  { title: 'カナ', key: 'kana', minWidth: 160, ellipsis: { tooltip: true } },
  { title: 'ステータス', key: 'status', width: 120 },
  { title: '会社ID', key: 'company_id', width: 160 },
  { title: '所属拠点', key: 'branches', minWidth: 260, render: (row: Row) => renderBranches(row) },
  {
    title: '操作',
    key: 'actions',
    width: 180,
    render: (row: Row) => h('div', null, [
      h(NButton, {
        size: 'small',
        tertiary: true,
        style: 'margin-right:8px',
        onClick: () => router.push({ name: 'user-detail', params: { id: row.id } })
      }, { default: () => '詳細' }),
      h(NButton, {
        size: 'small',
        onClick: () => router.push({ name: 'user-edit', params: { id: row.id } })
      }, { default: () => '編集' })
    ])
  }
]
</script>

<template>
  <div>
    <n-spin :show="loading">
      <n-data-table :columns="columns" :data="rows" :bordered="false" />
    </n-spin>
  </div>
</template>
```

## src/views/users/UserUpsert.vue

```vue
<script setup lang="ts">
import { ref, computed, onMounted, nextTick, onBeforeUnmount } from 'vue'
import { useRoute, useRouter } from 'vue-router'
import { fromCare } from '@/lib/supabase'
import { TABLE } from '@/lib/contracts'
import { useImeGuard, pushUniqueTag } from '@/lib/utils'
import { useMessage } from 'naive-ui'
import type { InputInst } from 'naive-ui'

type UserForm = {
  id?: string
  name: string
  kana?: string | null
  birthdate?: string | null
  sex?: string | null
  phone?: string | null
  address?: string | null
  emergency_contact_name?: string | null
  emergency_contact_relation?: string | null
  emergency_contact_phone?: string | null
  allergies?: string[]
  diagnoses?: string[]
  medications?: string | null
  care_level?: string | null
  care_insurance_id?: string | null
  physician_name?: string | null
  physician_clinic?: string | null
  physician_phone?: string | null
  diet?: string | null
  swallowing_caution?: string | null
  fall_risk?: boolean | null
  dementia_stage?: string | null
  mobility?: string | null
  adl_notes?: string | null
  preferences?: string | null
  communication_notes?: string | null
  photo_url?: string | null
}

const route = useRoute()
const router = useRouter()
const message = useMessage()
const id = route.params.id as string | undefined
const isEdit = computed(() => !!id)

const formRef = ref()
const submitting = ref(false)
const form = ref<UserForm>({
  name: '',
  kana: '',
  birthdate: '',
  sex: '',
  phone: '',
  address: '',
  emergency_contact_name: '',
  emergency_contact_relation: '',
  emergency_contact_phone: '',
  allergies: [],
  diagnoses: [],
  medications: '',
  care_level: '',
  care_insurance_id: '',
  physician_name: '',
  physician_clinic: '',
  physician_phone: '',
  diet: '',
  swallowing_caution: '',
  fall_risk: null,
  dementia_stage: '',
  mobility: '',
  adl_notes: '',
  preferences: '',
  communication_notes: '',
  photo_url: ''
})

/** ▼ 所属拠点（複数選択） */
const branchOptions = ref<{ label: string; value: string }[]>([])
const selectedBranchIds = ref<string[]>([])
let originalBranchIds: string[] = []

async function loadBranchOptions () {
  const { data, error } = await fromCare(TABLE.branches)
    .select('id, name')
    .order('name', { ascending: true })
  if (error) {
    console.warn('[UserUpsert] loadBranchOptions error:', error)
    return
  }
  branchOptions.value = (data ?? []).map((b: any) => ({
    label: b?.name ?? b?.id,
    value: b?.id
  }))
}

const sexOptions = [
  { label: '男性', value: 'male' },
  { label: '女性', value: 'female' },
  { label: 'その他', value: 'other' },
  { label: '不明', value: 'unknown' }
]
const dietOptions = [
  { label: '常食', value: 'normal' },
  { label: '軟菜', value: 'soft' },
  { label: 'きざみ', value: 'minced' },
  { label: 'ミキサー', value: 'pureed' }
]

const rules = {
  name: { required: true, message: '氏名は必須です', trigger: ['blur', 'input'] }
}

/** ▼ タグ入力（IME二度押しガード） */
const newAllergyTag   = ref<string>('')
const newDiagnosisTag = ref<string>('')
const { onCompStart, onCompEnd, onEnter, onBlur } = useImeGuard({ doubleEnterWindowMs: 800 })
const allergyInputRef   = ref<InputInst | null>(null)
const diagnosisInputRef = ref<InputInst | null>(null)
function addAllergy() {
  form.value.allergies = pushUniqueTag(form.value.allergies, newAllergyTag.value)
  newAllergyTag.value = ''
}
function addDiagnosis() {
  form.value.diagnoses = pushUniqueTag(form.value.diagnoses, newDiagnosisTag.value)
  newDiagnosisTag.value = ''
}
let removeAllergyListeners: (() => void) | null = null
let removeDiagnosisListeners: (() => void) | null = null

onMounted(async () => {
  await loadBranchOptions()
  await loadExisting()

  // ネイティブイベントを直接バインド（Enter二度押し）
  await nextTick()
  const bind = (inst: InputInst | null, addFn: () => void) => {
    const el = inst?.inputElRef
    if (!el) return () => {}
    const handleKeyDown  = (evt: KeyboardEvent) => { if (evt.key === 'Enter') onEnter(addFn)(evt) }
    const handleCompStart = () => onCompStart()
    const handleCompEnd   = () => onCompEnd()
    const handleBlur_     = () => onBlur()
    el.addEventListener('keydown', handleKeyDown)
    el.addEventListener('compositionstart', handleCompStart as any)
    el.addEventListener('compositionend', handleCompEnd as any)
    el.addEventListener('blur', handleBlur_ as any)
    return () => {
      el.removeEventListener('keydown', handleKeyDown)
      el.removeEventListener('compositionstart', handleCompStart as any)
      el.removeEventListener('compositionend', handleCompEnd as any)
      el.removeEventListener('blur', handleBlur_ as any)
    }
  }
  removeAllergyListeners   = bind(allergyInputRef.value,   addAllergy)
  removeDiagnosisListeners = bind(diagnosisInputRef.value, addDiagnosis)
})

onBeforeUnmount(() => {
  removeAllergyListeners?.()
  removeDiagnosisListeners?.()
  removeAllergyListeners = removeDiagnosisListeners = null
})

/** ▼ 既存値の読込（所属拠点も） */
async function loadExisting () {
  if (!isEdit.value) return
  const { data, error } = await fromCare(TABLE.users)
    .select(`
      id, name, kana, birthdate, sex,
      phone, address,
      emergency_contact_name, emergency_contact_relation, emergency_contact_phone,
      allergies, diagnoses, medications,
      care_level, care_insurance_id,
      physician_name, physician_clinic, physician_phone,
      diet, swallowing_caution,
      fall_risk, dementia_stage,
      mobility, adl_notes,
      preferences, communication_notes,
      photo_url
    `)
    .eq('id', id!)
    .single()
  if (error) throw error

  form.value = {
    ...(data as any),
    allergies: Array.isArray((data as any).allergies) ? (data as any).allergies : [],
    diagnoses: Array.isArray((data as any).diagnoses) ? (data as any).diagnoses : []
  }

  // 所属拠点の取得
  const { data: memb, error: mErr } = await fromCare(TABLE.userBranchMemberships)
    .select('branch_id')
    .eq('user_id', id!)
  if (!mErr) {
    originalBranchIds = (memb ?? []).map((m: any) => m.branch_id)
    selectedBranchIds.value = originalBranchIds.slice()
  }
}

/** ▼ 所属拠点の差分保存 */
async function saveMembershipDiff(userId: string, nextBranchIds: string[]) {
  const prev = new Set(originalBranchIds)
  const next = new Set(nextBranchIds)

  const toAdd: string[] = []
  const toRemove: string[] = []

  next.forEach(bid => { if (!prev.has(bid)) toAdd.push(bid) })
  prev.forEach(bid => { if (!next.has(bid)) toRemove.push(bid) })

  if (toAdd.length > 0) {
    const rows = toAdd.map(bid => ({ user_id: userId, branch_id: bid }))
    const { error } = await fromCare(TABLE.userBranchMemberships).insert(rows)
    if (error) throw error
  }
  if (toRemove.length > 0) {
    const { error } = await fromCare(TABLE.userBranchMemberships)
      .delete()
      .eq('user_id', userId)
      .in('branch_id', toRemove)
    if (error) throw error
  }

  // 保存後、基準を更新
  originalBranchIds = nextBranchIds.slice()
}

async function save () {
  try {
    await formRef.value?.validate()
    submitting.value = true

    // 1) users 本体
    if (isEdit.value) {
      const { error } = await fromCare(TABLE.users).update({ ...form.value }).eq('id', form.value.id!)
      if (error) throw error

      // 2) 所属拠点の差分
      await saveMembershipDiff(form.value.id!, selectedBranchIds.value)

      message.success('更新しました')
    } else {
      // 新規 → ID を返してもらって memberships を作る
      const { data, error } = await fromCare(TABLE.users)
        .insert({ ...form.value })
        .select('id')
        .single()
      if (error) throw error
      const newId = (data as any)?.id as string
      if (newId) {
        await saveMembershipDiff(newId, selectedBranchIds.value)
      }
      message.success('追加しました')
    }

    router.push({ name: 'user-list' })
  } catch (e: any) {
    console.error(e)
    message.error(e?.message ?? '保存に失敗しました')
  } finally {
    submitting.value = false
  }
}
</script>

<template>
  <div class="max-w-4xl">
    <n-card>
      <div class="flex items-center justify-between mb-2">
        <h1 class="text-lg font-semibold">利用者{{ isEdit ? '編集' : '新規登録' }}</h1>
        <n-button tertiary @click="$router.push({ name: 'user-list' })">一覧へ</n-button>
      </div>

      <n-form ref="formRef" :model="form" :rules="rules" label-placement="top">
        <!-- 基本情報 -->
        <n-divider>基本情報</n-divider>
        <n-form-item label="氏名" path="name">
          <n-input v-model:value="form.name" clearable />
        </n-form-item>
        <n-form-item label="カナ" path="kana">
          <n-input v-model:value="form.kana" clearable />
        </n-form-item>
        <n-form-item label="生年月日 (YYYY-MM-DD)" path="birthdate">
          <n-input v-model:value="form.birthdate" placeholder="例: 1940-01-23" clearable />
        </n-form-item>
        <n-form-item label="性別" path="sex">
          <n-select v-model:value="form.sex" :options="sexOptions" clearable />
        </n-form-item>

        <!-- 所属拠点（複数選択） -->
        <n-form-item label="所属拠点" path="branches">
          <n-select
            v-model:value="selectedBranchIds"
            :options="branchOptions"
            multiple
            clearable
            filterable
            placeholder="所属する拠点を選択（複数可）"
            style="max-width: 520px"
          />
        </n-form-item>

        <!-- 連絡先 -->
        <n-divider>連絡先</n-divider>
        <n-form-item label="電話" path="phone">
          <n-input v-model:value="form.phone" clearable />
        </n-form-item>
        <n-form-item label="住所" path="address">
          <n-input v-model:value="form.address" type="textarea" :autosize="{ minRows: 2, maxRows: 4 }" />
        </n-form-item>

        <!-- 緊急連絡先 -->
        <n-divider>緊急連絡先</n-divider>
        <n-form-item label="氏名" path="emergency_contact_name">
          <n-input v-model:value="form.emergency_contact_name" clearable />
        </n-form-item>
        <n-form-item label="続柄" path="emergency_contact_relation">
          <n-input v-model:value="form.emergency_contact_relation" clearable />
        </n-form-item>
        <n-form-item label="電話" path="emergency_contact_phone">
          <n-input v-model:value="form.emergency_contact_phone" clearable />
        </n-form-item>

        <!-- 医療情報 -->
        <n-divider>医療情報</n-divider>
        <n-form-item label="アレルギー（タグ）" path="allergies">
          <n-dynamic-tags v-model:value="form.allergies" />
          <div class="mt-2 flex items-center gap-2">
            <n-input
              ref="allergyInputRef"
              size="small"
              v-model:value="newAllergyTag"
              placeholder="タグを入力（日本語可）"
              class="max-w-[240px]"
            />
            <n-button size="small" @click="addAllergy">追加</n-button>
          </div>
        </n-form-item>
        <n-form-item label="既往・診断名（タグ）" path="diagnoses">
          <n-dynamic-tags v-model:value="form.diagnoses" />
          <div class="mt-2 flex items-center gap-2">
            <n-input
              ref="diagnosisInputRef"
              size="small"
              v-model:value="newDiagnosisTag"
              placeholder="タグを入力（日本語可）"
              class="max-w-[240px]"
            />
            <n-button size="small" @click="addDiagnosis">追加</n-button>
          </div>
        </n-form-item>
        <n-form-item label="内服・処方" path="medications">
          <n-input v-model:value="form.medications" type="textarea" :autosize="{ minRows: 2, maxRows: 6 }" />
        </n-form-item>

        <!-- 介護保険 -->
        <n-divider>介護保険</n-divider>
        <n-form-item label="要介護区分" path="care_level">
          <n-input v-model:value="form.care_level" placeholder="例: 要介護2" />
        </n-form-item>
        <n-form-item label="被保険者番号" path="care_insurance_id">
          <n-input v-model:value="form.care_insurance_id" />
        </n-form-item>

        <!-- 主治医 -->
        <n-divider>主治医</n-divider>
        <n-form-item label="氏名" path="physician_name">
          <n-input v-model:value="form.physician_name" />
        </n-form-item>
        <n-form-item label="医療機関" path="physician_clinic">
          <n-input v-model:value="form.physician_clinic" />
        </n-form-item>
        <n-form-item label="電話" path="physician_phone">
          <n-input v-model:value="form.physician_phone" />
        </n-form-item>

        <!-- 食事・嚥下 -->
        <n-divider>食事・嚥下</n-divider>
        <n-form-item label="食形態" path="diet">
          <n-select v-model:value="form.diet" :options="dietOptions" clearable />
        </n-form-item>
        <n-form-item label="嚥下注意点" path="swallowing_caution">
          <n-input v-model:value="form.swallowing_caution" type="textarea" :autosize="{ minRows: 2, maxRows: 4 }" />
        </n-form-item>

        <!-- リスク・認知 -->
        <n-divider>リスク・認知</n-divider>
        <n-form-item label="転倒リスク" path="fall_risk">
          <n-switch v-model:value="form.fall_risk">
            <template #checked>あり</template>
            <template #unchecked>なし</template>
          </n-switch>
        </n-form-item>
        <n-form-item label="認知症ステージ" path="dementia_stage">
          <n-input v-model:value="form.dementia_stage" />
        </n-form-item>

        <!-- 生活・ADL -->
        <n-divider>生活・ADL</n-divider>
        <n-form-item label="移動・補助具など" path="mobility">
          <n-input v-model:value="form.mobility" type="textarea" :autosize="{ minRows: 2, maxRows: 4 }" />
        </n-form-item>
        <n-form-item label="ADLメモ" path="adl_notes">
          <n-input v-model:value="form.adl_notes" type="textarea" :autosize="{ minRows: 2, maxRows: 4 }" />
        </n-form-item>

        <!-- 好み・配慮 -->
        <n-divider>好み・配慮</n-divider>
        <n-form-item label="好み・NG" path="preferences">
          <n-input v-model:value="form.preferences" type="textarea" :autosize="{ minRows: 2, maxRows: 4 }" />
        </n-form-item>
        <n-form-item label="伝達・配慮事項" path="communication_notes">
          <n-input v-model:value="form.communication_notes" type="textarea" :autosize="{ minRows: 2, maxRows: 4 }" />
        </n-form-item>

        <div class="flex justify-end gap-2 pt-2">
          <n-button ghost @click="$router.push({ name: 'user-list' })">キャンセル</n-button>
          <n-button type="primary" :loading="submitting" @click="save">保存</n-button>
        </div>
      </n-form>
    </n-card>
  </div>
</template>```

## src/vite-env.d.ts

```ts
/// <reference types="vite/client" />
```

## supabase/functions/admin-sync-auth/index.ts

```ts
// supabase/functions/admin-sync-auth/index.ts
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

// ---- CORS -------------------------------------------------
const corsHeaders: Record<string, string> = {
  'Access-Control-Allow-Origin': '*', // 必要があればドメインを絞る
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
  'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
}
const json = (body: unknown, init: ResponseInit = {}) =>
  new Response(JSON.stringify(body), {
    ...init,
    headers: { 'Content-Type': 'application/json', ...corsHeaders, ...(init.headers || {}) },
  })
// -----------------------------------------------------------

const SUPABASE_URL = Deno.env.get('FUNC_SUPABASE_URL')!
const SERVICE_ROLE = Deno.env.get('FUNC_SERVICE_ROLE_KEY')!
const ANON_KEY     = Deno.env.get('FUNC_ANON_KEY')!  // RLS検証用

// service-role（RLS無視）クライアント
const adminDb = createClient(SUPABASE_URL, SERVICE_ROLE, {
  auth: { persistSession: false },
  db: { schema: 'public' },
})

const isPrivileged = (role: string | null) => role === 'admin' || role === 'manager'

Deno.serve(async (req: Request) => {
  // Preflight
  if (req.method === 'OPTIONS') return new Response('ok', { headers: corsHeaders })

  try {
    const url = new URL(req.url)
    const jwt = req.headers.get('authorization')?.replace(/^Bearer\s+/i, '') || null

    // --- 認証付き ping（開発用） ------------------------------
    if (url.searchParams.get('ping') === '1') {
      if (!jwt) return json({ code: 401, message: 'Missing authorization header' }, { status: 401 })

      const callerDb = createClient(SUPABASE_URL, ANON_KEY, {
        global: { headers: { Authorization: `Bearer ${jwt}` } },
        db: { schema: 'public' },
      })

      const { data: meUser, error: meUserErr } = await callerDb.auth.getUser()
      if (meUserErr) return json({ error: 'auth.getUser failed', detail: meUserErr.message }, { status: 401 })

      const { data: me, error: meErr } = await callerDb
        .from('staffs')
        .select('id, role, auth_user_id')
        .eq('auth_user_id', meUser.user?.id ?? '')
        .maybeSingle()

      if (meErr) return json({ error: 'fetch caller staff failed', detail: meErr.message }, { status: 500 })
      return json({ ok: true, me })
    }

    // --- POST 以外は拒否 -------------------------------------
    if (req.method !== 'POST') return json({ error: 'method not allowed' }, { status: 405 })
    if (!jwt) return json({ error: 'unauthorized' }, { status: 401 })

    const { staff_id } = await req.json().catch(() => ({}))
    if (!staff_id) return json({ error: 'staff_id required' }, { status: 400 })

    // --- 呼び出しユーザの権限確認（RLS 越し） -----------------
    const callerDb = createClient(SUPABASE_URL, ANON_KEY, {
      global: { headers: { Authorization: `Bearer ${jwt}` } },
      db: { schema: 'public' },
    })

    const { data: callerUser, error: callerUserErr } = await callerDb.auth.getUser()
    if (callerUserErr) {
      console.error('[admin-sync-auth] caller getUser err:', callerUserErr)
      return json({ error: 'unauthorized' }, { status: 401 })
    }

    const { data: caller, error: callerErr } = await callerDb
      .from('staffs')
      .select('id, role')
      .eq('auth_user_id', callerUser.user?.id ?? '')
      .maybeSingle()

    if (callerErr) {
      console.error('[admin-sync-auth] fetch caller staff err:', callerErr)
      return json({ error: 'internal error', detail: callerErr.message }, { status: 500 })
    }
    if (!caller || !isPrivileged(caller.role)) {
      return json({ error: 'forbidden' }, { status: 403 })
    }

    // --- 対象スタッフ（service-roleで直参照） ----------------
    const { data: staff, error: staffErr } = await adminDb
      .from('staffs')
      .select('id, email, role, auth_user_id')
      .eq('id', staff_id)
      .single()

    if (staffErr) {
      console.error('[admin-sync-auth] load staff err:', staffErr)
      return json({ error: 'staff not found', detail: staffErr.message }, { status: 404 })
    }

    const needsAuth = isPrivileged(staff.role)
    const email = (staff.email ?? '').trim() || null

    // --- revoke: ログイン不要/メール無し -----------------------
    if (!needsAuth || !email) {
      if (staff.auth_user_id) {
        const { error: delErr } = await adminDb.auth.admin.deleteUser(staff.auth_user_id)
        if (delErr && !String(delErr.message || '').toLowerCase().includes('not found')) {
          console.error('[admin-sync-auth] deleteUser err:', delErr)
          return json({ error: 'internal error', detail: delErr.message }, { status: 500 })
        }
        const { error: updErr } = await adminDb
          .from('staffs')
          .update({ auth_user_id: null })
          .eq('id', staff.id)
        if (updErr) {
          console.error('[admin-sync-auth] unlink auth_user_id err:', updErr)
          return json({ error: 'internal error', detail: updErr.message }, { status: 500 })
        }
      }
      return json({ ok: true, action: 'revoke-auth', staff_id })
    }

    // --- ensure: ログイン必要（email あり） -------------------
    if (staff.auth_user_id) {
      const { data: u, error: getErr } = await adminDb.auth.admin.getUserById(staff.auth_user_id)
      if (getErr) {
        console.error('[admin-sync-auth] getUserById err:', getErr)
        return json({ error: 'internal error', detail: getErr.message }, { status: 500 })
      }
      if (u?.user && u.user.email !== email) {
        const { error: upErr } = await adminDb.auth.admin.updateUserById(staff.auth_user_id, { email })
        if (upErr) {
          const msg = String(upErr.message || '').toLowerCase()
          if (msg.includes('already registered') || msg.includes('already exists')) {
            return json({ error: 'email_conflict' }, { status: 409 })
          }
          console.error('[admin-sync-auth] updateUserById err:', upErr)
          return json({ error: 'internal error', detail: upErr.message }, { status: 500 })
        }
      }
      return json({ ok: true, action: 'update-email', staff_id })
    }

    // --- 新規作成 ---------------------------------------------
    const { data: created, error: createErr } = await adminDb.auth.admin.createUser({
      email,
      email_confirm: true,
      app_metadata: { role: staff.role },
      user_metadata: { source: 'admin-sync-auth', staff_id: staff.id },
    })
    if (createErr || !created?.user) {
      const msg = String(createErr?.message || '').toLowerCase()
      if (msg.includes('already registered') || msg.includes('already exists')) {
        return json({ error: 'email_conflict' }, { status: 409 })
      }
      console.error('[admin-sync-auth] createUser err:', createErr)
      return json({ error: 'internal error', detail: createErr?.message || 'create failed' }, { status: 500 })
    }

    const { error: linkErr } = await adminDb
      .from('staffs')
      .update({ auth_user_id: created.user.id })
      .eq('id', staff.id)
    if (linkErr) {
      console.error('[admin-sync-auth] link auth_user_id err:', linkErr)
      return json({ error: 'internal error', detail: linkErr.message }, { status: 500 })
    }

    return json({ ok: true, action: 'ensure-auth', staff_id })
  } catch (e: any) {
    console.error('[admin-sync-auth] unhandled error:', e)
    return json({ error: 'internal error', detail: e?.message ?? String(e) }, { status: 500 })
  }
})```

